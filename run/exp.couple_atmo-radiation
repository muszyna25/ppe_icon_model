#!/bin/ksh
#=============================================================================
#
# Test experiment, running the hat_jww and hom_slm_flat experiments in parallel
#
#=============================================================================
# This section of the run script defines the experiment.
# The specifications are passed by namelist to the program.
# For a complete list see Namelist_overview.pdf
#
# Marco Giorgetta, MPI-M, 2011-01-29
# Hui Wan,         MPI-M, 2010-08-17
# Leonidas Linardakis, MPI-M, 2011-07-20
#
#-----------------------------------------------------------------------------
#
# Basic specifications of the simulation
# --------------------------------------
#
# These variables are set in the header section of the completed run script:
#   EXPNAME = experiment name
#   nproma  = array blocking length / inner loop length
# They may be overwritten here
#
#-----------------------------------------------------------------------------
#
#-----------------------------------------------------------------------------
# ATMO
#-----------------------------------------------------------------------------
# The following values must be set here as shell variables so that they can be used
# also in the executing section of the completed run script
#-----------------------------------------------------------------------------

#-----------------------------------------------------------------------------
# the namelist filename
atmo_namelist=NAMELIST_${EXPNAME}_atmo
#-----------------------------------------------------------------------------
# global timing
start_date="2008-09-01T00:00:00Z"
ndays_restart=60
dt_restart=`expr ${ndays_restart} \* 86400`

#-----------------------------------------------------------------------------
# model timing
dtime=840
ndays=10
nsteps=`expr ${ndays} \* 86400 / ${dtime}`
nsteps=17
dt_rad=1680
dt_conv=840
dt_sso=$dt_conv
#-------------------------
dt_data=`expr 60 \* 86400`   # output every 60 days
dt_file=`expr 180 \* 86400`  # new file every 180 days ${dt_file}
dt_diag= ${dt_data}

#-----------------------------------------------------------------------------
# model parameters
atmo_model_equations=3   # 3=non-hydrost. atm.,
iforcing=3               # 3 NWP forcing
nlev=31                  # nlev = number of full levels
#-----------------------------------------------------------------------------
# the grid files
atmo_dyn_grids="iconR2B03-grid.nc"
#-----------------------------------------------------------------------------


#-----------------------------------------------------------------------------
# write ICON namelist parameters
# ------------------------
# For a complete list see Namelist_overview and Namelist_overview.pdf
#  
cat > $atmo_namelist << EOF
!
&parallel_nml
 nproma         = ${nproma}
 p_test_run     = .false.
 l_test_openmp  = .false.
 l_log_checks   = .false.
 division_method   = 1
 n_ghost_rows      = 1
 parallel_radiation_mpi  = .false.
 parallel_radiation_omp  = .false.
 test_parallel_radiation = .false.
 radiation_threads       = 2
 nh_stepping_threads     = 1 
/
&grid_nml
 ! cell_type is not used = 3            ! triangular cells
 dynamics_grid_filename = "${atmo_dyn_grids}",
/
&nh_testcase_nml
 nh_test_name      = 'APE_nh'     ! test case identifier
 ape_sst_case      = 'sst1'
/
&run_nml
 ltestcase   = .TRUE.       ! run testcase
 ldynamics   = .TRUE.       ! dynamics
 ltimer      = .TRUE.
 ltransport  = .TRUE.       ! tracer transport
 num_lev     = ${nlev},     ! number of full levels of vertical grid
 nsteps      = ${nsteps}    ! [day] length of run
 dtime       = ${dtime}     ! [s] timestep
 iforcing    = ${iforcing}
 ntracer     = 6            ! 6 plus 1 for ozone
 msg_level   = 15           ! detailed report during integration
 ltimer      = .true.
 timers_level= 2
/
&dynamics_nml
 iequations  = ${atmo_model_equations}
 idiv_method     = 1
 divavg_cntrwgt  = 0.50
/
&nonhydrostatic_nml
 itime_scheme    = 5        ! default 4; 5: modified Matsuno for better numerical stability of sound waves
 iadv_rhotheta   = 2
 ivctype         = 2        ! set vertical grid automatically using sleve_ctl
 igradp_method   = 2        ! new default
 exner_expol     = 0.60     ! exner function extrapolation?
 rayleigh_coeff  = 0.05     ! Rayleigh coefficient for damping in upper levels
 damp_height     = 35000.   ! damping height (set about 10km below top)
 vwind_offctr    = 0.2      ! off-centering for time differencing (like alpha in turb)
 l_open_ubc      = .TRUE.   ! top open upper boundary condition. might help to go higher
/
&transport_nml
 ihadv_tracer  = 2,2,2,2,2,0
 ivadv_tracer  = 3,3,3,3,3,0
 igrad_c_miura = 1
 lvadv_tracer  = .TRUE.
 lstrang       = .FALSE.
 itype_hlimit  = 3
 itype_vlimit  = 1
 iord_backtraj = 1          ! default: 1
/
&diffusion_nml
 hdiff_order      = 5
 hdiff_efdt_ratio = 4.0
 lhdiff_vn        = .TRUE.
 lhdiff_temp      = .FALSE.
 hdiff_multfac    = 1.0
 hdiff_tv_ratio   = 1.0
/
&interpol_nml
  lsq_high_ord   = 2
/
&nwp_phy_nml
 inwp_gscp       = 1
 inwp_convection = 1
 inwp_cldcover   = 3        ! 0: no cld, 1: grid scale, 3: COSMO
 inwp_radiation  = 1        ! 1: RRTM, 2: Ritter-Geleyn
 inwp_turb       = 4        ! 1: Raschendorfer, 3: EDMF-DUALM, 4: ECHAM
 inwp_satad      = 1
 inwp_sso        = 0
 inwp_surface    = 0
 dt_conv         = ${dt_conv}
 dt_rad          = ${dt_rad}
 dt_sso          = ${dt_sso}
/
&radiation_nml
 irad_o3         = 6        ! 0: no ozone, 6: ozone, attention: increase ntracer by one
 izenith         = 3        ! 4: NWP default, 3: no annual cycle
/
&io_nml
 dt_diag     = ${dt_diag}
/
EOF
#-----------------------------------------------------------------------------

#-----------------------------------------------------------------------------
# RADIATION
#-----------------------------------------------------------------------------
# The following values must be set here as shell variables so that they can be used
# also in the executing section of the completed run script
#-----------------------------------------------------------------------------
# the namelist filename
# radiation_namelist=NAMELIST_${EXPNAME}_atmo
#
#-----------------------------------------------------------------------------



#-----------------------------------------------------------------------------
#split the number of procs in two for each of the dummy component
atmo_min_rank=0
atmo_max_rank=`expr ${mpi_total_procs} / 2`
atmo_inc_rank=1

radiation_min_rank=`expr ${atmo_max_rank} + 1`
radiation_max_rank=`expr ${mpi_total_procs} - 1`
radiation_inc_rank=1

radiation_min_rank=0
radiation_max_rank=`expr ${mpi_total_procs} - 1`
radiation_inc_rank=1
#-----------------------------------------------------------------------------
