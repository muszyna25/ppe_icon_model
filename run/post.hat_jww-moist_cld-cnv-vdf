#=============================================================================
#
# This section sets up the environment for the proper postprocessing script.
# Parameters are passed by the "${set_env}" file to be executed by the pp script.
#
#-----------------------------------------------------------------------------

# Set parameters for postprocessing
#
Model="ICOHAM"
EXP="test_hat_jww-moist_cld-cnv-vdf"
grid_name="iconR2B04-grid"
ExpName="${EXP}_${grid_name}"
plotBaseName="${EXP}_R2B04L31"
config_string="JWw-Moist R2B04"
cell_type=3
horizontal_resolution="R2B04"
vertical_resolution="L31"
physics=2
DOMAIN=""
output_frequency=4
data_file_split=1
post_start=2
post_end=2
plot_file_format="eps"
multi_panel=0
cn_plot_option=1
interp_option=1
rm_tmp_files=1
cdo_silence=1

cd ../scripts/postprocessing/testcases

# define individual set-env file
set_env="Post.${EXP}.set_env"

# Remove old ${set_env} file
#
if [ -f ${set_env} ] 
then 
  rm -f ${set_env}
fi

# Write new ${set_env} file
#
echo "export Model=\"${Model}\""                          >  ${set_env}
echo "EXP=\"${EXP}\""                                     >> ${set_env}
echo "grid_name=\"${grid_name}\""                         >> ${set_env}
echo "ExpName=\"${ExpName}\""                             >> ${set_env}
echo "plotBaseName=\"${plotBaseName}\""                   >> ${set_env}
echo "config_string=\"${config_string}\""                 >> ${set_env}
echo "export cell_type=${cell_type}"                      >> ${set_env}
echo "horizontal_resolution=\"${horizontal_resolution}\"" >> ${set_env}
echo "vertical_resolution=\"${vertical_resolution}\""     >> ${set_env}
echo "physics=${physics}"                                 >> ${set_env}
echo "DOMAIN=\"${DOMAIN}\""                               >> ${set_env}
echo "export output_frequency=${output_frequency}"        >> ${set_env}
echo "data_file_split=${data_file_split}"                 >> ${set_env}
echo "export post_start=${post_start}"                    >> ${set_env}
echo "export post_end=${post_end}"                        >> ${set_env}
echo "export plot_file_format=\"${plot_file_format}\""    >> ${set_env}
echo "export multi_panel=${multi_panel}"                  >> ${set_env}
echo "cn_plot_option=${cn_plot_option}"                   >> ${set_env}
echo "interp_option=${interp_option}"                     >> ${set_env}
echo "rm_tmp_files=${rm_tmp_files}"                       >> ${set_env}
echo "cdo_silence=${cdo_silence}"                         >> ${set_env}

# Load NCL resources
#
export NCARG_USRRESFILE=${WORKING_PATH}/scripts/postprocessing/.hluresfile

# Start postprocessing script
echo "-- ---------------------------------------------------------"
echo "-- JWw-Moist_postpro_driver.bash starts at $(date) --"
echo "-- ---------------------------------------------------------"
#
./JWw-Moist_postpro_driver.bash ${set_env}
STATUS=$?
echo "-- ---------------------------------------------------------"
echo "-- JWw-Moist_postpro_driver.bash ends at $(date) --"
echo "-- ---------------------------------------------------------"

#rm -f ${set_env}

check_error $STATUS "Creating of Plots"

#--------------------------------------------------------------------
# compare the restart files
cd $ICON_BASE_PATH/run
atmo_restart_1="../experiments/test_hat_jww-moist_cld-cnv-vdf/restart.iconR2B04-grid_20080903T000000Z_atm.nc"
atmo_restart_2="../experiments/test_hat_jww-moist_cld-cnv-vdf_restart/restart.iconR2B04-grid_20080903T000000Z_atm.nc"
#atmo_restart_2="../experiments/test_hat_jww-moist_cld-cnv-vdf/restart.iconR2B04-grid_20080903T000000Z_atm.nc"

out_file="test_hat_jww-moist_cld-cnv-vdf_restart.diff"
${cdo_diff} $atmo_restart_1 $atmo_restart_2 > $out_file
grep " 0 of 1876 records differ" $out_file
return_status=$?
if [ $return_status != 0 ] ; then
  cat $out_file
fi
check_error $return_status "restart differs"
#--------------------------------------------------------------------


exit $STATUS
