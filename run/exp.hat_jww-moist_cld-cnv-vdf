#!/bin/ksh
#=============================================================================
#
# This section of the run script containes the specifications of the experiment.
# The specifications are passed by namelist to the program.
# For a complete list see Namelist_overview.pdf
#
# Marco Giorgetta, MPI-M, 2010-04-21
# Hui Wan,         MPI-M, 2011-03-24
#
#-----------------------------------------------------------------------------
#
# Basic specifications of the simulation
# --------------------------------------
#
# These variables are set in the header section of the completed run script:
#
# EXPNAME = experiment name
# NPROMA  = array blocking length / inner loop length
#-----------------------------------------------------------------------------
# The following values must be set here as shell variables so that they can be used
# also in the executing section of the completed run script
#
#-----------------------------------------------------------------------------
# The following information is included to present some information on the buildbot-html main page
#
# _bb_table_Description_  Jablonowski Williamson baroclinic wave test + ECHAM physics
# _bb_table_Model_        hydrost. atmosphere
# _bb_table_Grid_         triangle
#-----------------------------------------------------------------------------
# the namelist filename
atmo_namelist=NAMELIST_${EXPNAME}
#
#-----------------------------------------------------------------------------
# global timing
start_date=${start_date:="2008-09-01T00:00:00Z"}
end_date=${end_date:="2008-09-03T00:00:00Z"}
ndays_restart=2
dt_restart=${dt_restart:=`expr ${ndays_restart} \* 86400`}
#
#-----------------------------------------------------------------------------
# model timing
dtime=600
dt_diag=`expr 24 \* 3600  `       # int output each 24 hours
dt_file=`expr 1 \* 86400 `        # write a data file for every day
dt_data=21600.                    # write output every 6 hours
dt_rad=3600.                      # compute radiative transfer every hour
dt_checkpoint=${dt_checkpoint:=`expr 1 \* 86400 `}  # write restart file every day
steps_per_file=4
#
#-----------------------------------------------------------------------------
# model parameters
atmo_model_equations=1 # equation system
#                     1=hydrost. atm.
#                     2=non-hydrost. atm., 
#                    -1=shallow water model
#                    -2=hydrost. ocean
nlev=31              # nlev = number of full levels
iforcing=2        # ECHAM physics
#
#-----------------------------------------------------------------------------
# the grid files
atmo_dyn_grids='iconR2B04-grid.nc'
#
#-----------------------------------------------------------------------------
# define variable names
#
dict_file='dict.cmor'
#
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
#
# ICON namelist parameters
# ------------------------
# For a complete list see Namelist_overview and Namelist_overview.pdf
#
cat > ${atmo_namelist} << EOF
!
&parallel_nml
 nproma      = ${nproma}
 use_icon_comm   = .true.
 icon_comm_debug = .false.
 max_send_recv_buffer_size = 262144
 ! l_log_checks    = .true.
/
&grid_nml
 dynamics_grid_filename = "${atmo_dyn_grids}",
/
&run_nml
 num_lev     = ${nlev},     ! number of full levels of vertical grid
 ! nsteps      = ${nsteps}    ! number of steps length of run
 dtime       = ${dtime}     ! [s] timestep in seconds
 ltestcase   = .TRUE.       ! run testcase                 --> testcase_ctl
 ldynamics   = .TRUE.       ! dynamics                     --> dynamics_ctl, diffusion_ctl
 ltransport  = .TRUE.       ! switch on tracer transport   --> transport_ctl
 ntracer     = 3            ! number of tracers
 iforcing    = ${iforcing}  ! forcing                      --> echam_phy_nml
 msg_level   = 10           ! detailed report during integration 
 ltimer = .TRUE.
 timers_level = 5
 activate_sync_timers = .TRUE.
 output="nml"
/
&dynamics_nml
 iequations  = ${atmo_model_equations}
/
&ha_dyn_nml
 ldry_dycore = .TRUE.       ! dry dynamical core
/
&ha_testcase_nml
 ctest_name  = 'JWw-Moist'  ! test case identifier
 lrh_linear_pres  = .TRUE.  ! initial RH is a linear function of pressure
 rh_at_1000hpa    = 0.75    ! [] initial rel. humidity at 1000 hPa 
/
&io_nml
 dt_checkpoint     = ${dt_checkpoint} ! [s] trigger new restart file
 output_nml_dict  = '${dict_file}'
 netcdf_dict      = '${dict_file}'
 lzaxis_reference = .false.
/
&output_nml
 output_bounds    = 0.0,${dt_restart},${dt_data}   ! start, end, increment
 steps_per_file   = ${steps_per_file}
 include_last     = .FALSE.
 output_grid      = .TRUE.
 output_filename  = "${EXPNAME}"
 ml_varlist       = 'ps'      , 'ts'      , 'ta'      ,
                    'hus'     , 'clw'     , 'cli'     ,
                    'ua'      , 'va'      , 'wap'     ,
                    'pfull'   , 'gpfull'  ,
                    'pr'      , 'prcr'    , 'prcs'    , 'prlr'    , 'prls'
                    'prw'     , 'cllvi'   , 'clivi'   , 'clt'
                    'evspsbl' , 'hfls'    , 'hfss'    ,
                    'rlns'    , 'rlnt'    , 'rsns'    , 'rsnt'    , 'rsdt'
/
&transport_nml
 ctracer_list='vwi'         ! v: water vapour, w: cloud water, i: cloud ice
/
&echam_phy_nml
 lrad = .FALSE.             ! no radiation
/
EOF
#
#-----------------------------------------------------------------------------
# add standard atmo_hydrostatic_files
. ${thisdir}/add_required_atmo_hydrostatic_files
# copy dictionary file for variable names
add_required_file ${basedir}/run/${dict_file} ./
#-----------------------------------------------------------------------------
