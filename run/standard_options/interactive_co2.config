--- exp.esm_R2B3_R2B4	2020-08-24 14:59:47.000000000 +0200
+++ exp.esm_R2B3_R2B4_ico2	2020-08-24 14:59:47.000000000 +0200
@@ -11,46 +11,42 @@
 # running on an R2B4 grid. The atmosphere is initialized from analysis files and
 # using constant pre-industrial (PI-control) boundary conditions for the year
 # 1850:
 # - spectral solar irradiation
 # - well mixed greenhouse gases CO2, CH4, N2O, no CFCs
 # - O3 concentration
 # - SST and sea ice are transferred via YAC from the ocean.
 # - and no (!) aerosols
 #
 # A test version for HD is included. Model is water mass conserving now.
-# Hamocc can be turned on, but is deactivated by default
 #
-# Here, the ocean is already spun up from Levitus climatology for 250 years.
-# initializing the Ocean from long tuning run (3600y) and hamocc variables from cmip6 restart is
-# is possible (initialiseOcean="fromRestartwithHamocc")
-# initialiseOcean="fromClimatology" is possible, see below.
+# Here, ocean is initialized from long (3600y) tuning run with good AMOC and sea-ice.
+# Hamocc is initialized with cmip6 data interpolated to icon-ocean grid.
+#
 #
 # The coupling:
 #
 # atmosphere -> ocean:
 # . surface_downward_eastward_stress
 # . surface_downward_northward_stress
 # . surface_fresh_water_flux
 # . total_heat_flux
 # . atmosphere_sea_ice_bundle
 # . river_runoff
+# . co2_mixing_ratio
 #
 # ocean -> atmosphere:
 # . sea_surface_temperature
 # . eastward_sea_water_velocity
 # . northward_sea_water_velocity
 # . ocean_sea_ice_bundle
 # . 10m_wind_speed
-#
-# currently not activated for coupling:
-# . co2_mixing_ratio
 # . co2_flux
 #
 #--------------------------------------------------------------------------------------------------
 
 # (0) Basic model configuration
 # -----------------------------
 
 atmos_gridID="0030"
 atmos_refinement="R02B03"
 
@@ -67,21 +63,21 @@
 # initialiseOcean="fromClimatology"
 # initialiseOcean="FALSE"
 
 read_restart_namelists=".false."
 
 # restart=.true.    # deactivate semaphore mechanism
 #
 # 1 ocean node is sufficient for low resolution, 9 nodes for coupled is suitable.
 # faster: 2 nodes for ocean, 16 nodes in total
 #         running with Hamocc: 8 nodes for ocean, 22 in total for similar performance
-mpi_oce_nodes=2
+mpi_oce_nodes=8
 #mpi_oce_nodes=${mpi_oce_nodes:=((no_of_nodes/2))}   # default: half of requested nodes
 ((mpi_oce_procs=mpi_oce_nodes * mpi_procs_pernode))
 #
 #--------------------------------------------------------------------------------------------------
 #
 # (1) Define the model time stepping
 # ----------------------------------
 
 # standard atmosphere timestep: 15 min, 8 substeps (r2b4 values)
 # atmospheric timesteps > 15 min are possible with a higher value in hdiff_smag_fac, see diffusion nml
@@ -134,37 +130,37 @@
 atmo_dyn_grid=${atm_grid_name}.nc
 
 #--------------------------------------------------------------------------------------------------
 
 # (4) Set variables to configure the experiment:
 # ----------------------------------------------
 
 # start and end date+time of experiment
 # -------------------------------------
 start_date=${start_date:="1000-01-01T00:00:00Z"}
-    end_date=${end_date:="1010-01-01T00:00:00Z"}
+    end_date=${end_date:="1002-01-01T00:00:00Z"}
 
 # restart/checkpoint/output intervals
 # -----------------
-restart_interval="P10Y"
-checkpoint_interval="P10Y"
+restart_interval="P1Y"
+checkpoint_interval="P1Y"
 
 # file interval is restart-interval
-atm_file_interval="P10Y"
-oce_file_interval="P10Y"
-lnd_file_interval="P10Y"
-hamocc_file_interval="P10Y"
-
-atm_output_interval="P1Y"
-oce_output_interval="P1Y"
-lnd_output_interval="P1Y"
-hamocc_output_interval="P1Y"
+atm_file_interval="P2Y"
+oce_file_interval="P2Y"
+lnd_file_interval="P2Y"
+hamocc_file_interval="P2Y"
+
+atm_output_interval="P1M"
+oce_output_interval="P1M"
+lnd_output_interval="P1M"
+hamocc_output_interval="P1M"
 
 # asynchronous diagnostic output processes
 # ----------------------------------------
 
 # Note that "mpi_atm_io_procs" must match the number of output files
 mpi_atm_io_procs=0      # >0 for atmosphere plus land (not working for monitoring)
 mpi_oce_io_procs=0      # >0 for ocean is not working yet
 
 # output file selection
 # ---------------------
@@ -210,21 +206,21 @@
 
 #--------------------------------------------------------------------------------------------------
 
 # (5) Define the model configuration
 #-----------------------------------
 
 # JSBACH settings
 run_jsbach=yes
 jsbach_usecase=jsbach_pfts    # jsbach_lite or jsbach_pfts
 jsbach_with_lakes=yes
-jsbach_with_carbon=no         # yes needs jsbach_pfts usecase
+jsbach_with_carbon=yes         # yes needs jsbach_pfts usecase
 
 # Some further processing for land configuration
 # ----------------------------------------------
 
 ljsbach=$([ "${run_jsbach:=no}" == yes ]          && echo .TRUE. || echo .FALSE. )
 llake=$([ "${jsbach_with_lakes:=yes}" == yes ]    && echo .TRUE. || echo .FALSE. )
 lcarbon=$([ "${jsbach_with_carbon:=yes}" == yes ] && echo .TRUE. || echo .FALSE. )
 
 if [[ $jsbach_usecase == *pfts* ]]
 then
@@ -574,20 +570,59 @@
                <target_timelag>${oce_lag}</target_timelag>
             </timestep>
             <mapping_on_source>true</mapping_on_source>
             <interpolation_requirements use_source_mask="true" use_target_mask="true">
                <interpolation method="source_to_target_map"/>
             </interpolation_requirements>
             <debug_mode at_source_after_interpolation="false" at_source_before_interpolation="false" at_target="false"/>
             <enforce_write_restart>false</enforce_write_restart>
             <enforce_write_weight_file filename="">false</enforce_write_weight_file>
          </transient_couple>
+         <transient_couple transient_id="12">
+            <source component_ref="1" transient_grid_ref="12"/>
+            <target transient_grid_ref="12"/>
+            <timestep>
+               <source>${atmTimeStep}</source>
+               <target>${oceTimeStep}</target>
+               <coupling_period operation="average">${couplingTimeStep}</coupling_period>
+               <source_timelag>${atm_lag}</source_timelag>
+               <target_timelag>${oce_lag}</target_timelag>
+            </timestep>
+            <mapping_on_source>true</mapping_on_source>
+            <interpolation_requirements use_source_mask="true" use_target_mask="true">
+               <interpolation method="bernstein_bezier"/>
+               <interpolation method="n-nearest_neighbor" n="4" weighted="ARITHMETIC_AVERAGE"/>
+               <interpolation method="fixed_value" user_value="-999.9"/>
+            </interpolation_requirements>
+            <debug_mode at_source_after_interpolation="false" at_source_before_interpolation="false" at_target="false"/>
+            <enforce_write_restart>false</enforce_write_restart>
+            <enforce_write_weight_file filename="">false</enforce_write_weight_file>
+         </transient_couple>
+         <transient_couple transient_id="13">
+            <source component_ref="2" transient_grid_ref="13"/>
+            <target transient_grid_ref="13"/>
+            <timestep>
+               <source>${oceTimeStep}</source>
+               <target>${atmTimeStep}</target>
+               <coupling_period operation="average">${couplingTimeStep}</coupling_period>
+               <source_timelag>${oce_lag}</source_timelag>
+               <target_timelag>${atm_lag}</target_timelag>
+            </timestep>
+            <mapping_on_source>true</mapping_on_source>
+            <interpolation_requirements use_source_mask="true" use_target_mask="true">
+               <interpolation enforced_conservation="false" method="conservative" normalisation="FRACAREA" order="1" partial_coverage="true"/>
+               <interpolation method="fixed_value" user_value="-999.9"/>
+            </interpolation_requirements>
+            <debug_mode at_source_after_interpolation="false" at_source_before_interpolation="false" at_target="false"/>
+            <enforce_write_restart>false</enforce_write_restart>
+            <enforce_write_weight_file filename="">false</enforce_write_weight_file>
+         </transient_couple>
       </couple>
    </couples>
    <created date="16-04-2019 15:49" tool="YAC-CouplingGUI v.1.5"/>
 </coupling>
 EOF
 
 #
 # xsd and xml files for yac
 # -------------------------
 #
@@ -653,25 +688,25 @@
  stretch_fac      = 0.9
  decay_scale_1    = 4000.       ! [m]
  decay_scale_2    = 2500.       ! [m]
  decay_exp        = 1.2
  flat_height      = 16000.      ! [m]
 /
 &diffusion_nml
  hdiff_smag_fac   = 0.015       ! default: 0.015  higher values will increase diffusion
 /
 &transport_nml
- tracer_names     = 'hus','clw','cli'
- ivadv_tracer     =    3 ,   3 ,   3
- itype_hlimit     =    4 ,   4 ,   4
- itype_vlimit     =    3 ,   3 ,   3
- ihadv_tracer     =   52 ,   2 ,   2
+ tracer_names     = 'hus','clw','cli','o3','co2'
+ ivadv_tracer     =    3 ,   3 ,   3 , 3  , 3
+ itype_hlimit     =    4 ,   4 ,   4 , 3  , 3
+ itype_vlimit     =    3 ,   3 ,   3 , 1  , 1
+ ihadv_tracer     =   52 ,   2 ,   2 , 52 , 52
 /
 &echam_phy_nml
 !
 ! domain 1
 ! --------
 !
 ! atmospheric phyiscs (""=never)
  echam_phy_config(1)%dt_rad = "${radTimeStep}"
  echam_phy_config(1)%dt_vdf = "${atmTimeStep}"
  echam_phy_config(1)%dt_cnv = "${atmTimeStep}"
@@ -695,21 +730,21 @@
  echam_phy_config(1)%iqneg_d2p = 0
  echam_phy_config(1)%iqneg_p2d = 0
 /
 &echam_rad_nml
 !
 ! domain 1
 ! --------
 !
  echam_rad_config(1)%isolrad    =  6
  echam_rad_config(1)%irad_h2o   =  1
- echam_rad_config(1)%irad_co2   =  2
+ echam_rad_config(1)%irad_co2   =  1
  echam_rad_config(1)%irad_ch4   =  2
  echam_rad_config(1)%irad_n2o   =  2
  echam_rad_config(1)%irad_o3    =  2          ! constant annual cycle climatology
  echam_rad_config(1)%irad_o2    =  2
  echam_rad_config(1)%irad_cfc11 =  0
  echam_rad_config(1)%irad_cfc12 =  0
  echam_rad_config(1)%irad_aero  =  0
  echam_rad_config(1)%vmr_co2    = 284.317e-6  ! constant volume mixing ratio, default: 348.0e-6
  echam_rad_config(1)%vmr_ch4    = 808.249e-9  ! constant volume mixing ratio, default: 1650.0e-9
  echam_rad_config(1)%vmr_n2o    = 273.021e-9  ! constant volume mixing ratio, default: 306.0e-9
@@ -736,20 +771,27 @@
 &echam_cld_nml
  echam_cld_config(1)%csecfrl    = 0.7e-5     ! threshold for ice and water in clouds, default 5.e-6
  echam_cld_config(1)%ccraut     = 2.0       ! default: 2.0      (old default: 15.0)
  echam_cld_config(1)%ccsaut     = 2.0       ! default: 2.0      (old default: 95.0)
  echam_cld_config(1)%cauloc     = 1.0       ! default: 1.0      (old default: 10.0)
 /
 &echam_cov_nml
  echam_cov_config(1)%crs        = 0.968     ! Critical relative humidity at surface, default 0.968
  echam_cov_config(1)%crt        = 0.9      ! Critical relative humidity at toa, default 0.8
 /
+&ccycle_nml
+ ccycle_config(1)%iccycle   = 1      ! 0: no ccycle
+                                     ! 1: ccycle (interactive atm. co2)
+                                     ! 2: ccycle (prescribed atm. co2)
+ ccycle_config(1)%ico2conc  = 2      ! atm. co2 source (if iccycle=2) (2: const., 4: transient from file)
+ ccycle_config(1)%vmr_co2   = 284.3e-06    ! CO2 volume mixing ratio (if ico2conc = 2), default: 284.3e-06
+/
 &sea_ice_nml
  albs         = 0.865         ! Albedo of snow (not melting)
  albsm        = 0.7         ! Albedo of snow (melting)
  albi         = 0.75         ! Albedo of ice (not melting)
  albim        = 0.7         ! Albedo of ice (melting)
 /
 EOF
 
 # jsbach namelist
 # ---------------
@@ -1046,21 +1088,22 @@
  output_end       = "${end_date}"
  output_interval  = "${atm_output_interval}"
  file_interval    = "${atm_file_interval}"
  include_last     = .FALSE.
  ml_varlist       = 'zg'      ,
                     'ps'      , 'pfull'   ,
                     'rho'     , 'ta'      ,
                     'ua'      , 'va'      , 'wap'     ,
                     'hus'     , 'clw'     , 'cli'     ,
                     'hur'     , 'cl'      ,
-!                    'qo3_phy' ,
+                    'qco2_phy', 'mco2vi_phy', 'tend_mco2vi_phy'
+!                    'qo3_phy' ,                                   
 /
 EOF
 fi
 
 
 if [[ "$output_atm_2d" == "yes" ]]; then
   #
   cat >> ${atm_namelist} << EOF
 &output_nml
  output_filename  = "${EXPNAME}_atm_2d"
@@ -1085,21 +1128,23 @@
                     'sic'     , 'sit'     ,
                     'albedo'  ,
                     'clt'     ,
                     'prlr'    , 'prls'    , 'prcr'    , 'prcs'    ,
                     'pr'      , 'prw'     , 'cllvi'   , 'clivi'   ,
                     'hfls'    , 'hfss'    , 'evspsbl' ,
                     'tauu'    , 'tauv'    ,
                     'tauu_sso', 'tauv_sso', 'diss_sso',
                     'sfcwind' , 'uas'     , 'vas'     ,
                     'tas'     , 'dew2'    ,
-                    'ptp'
+                    'ptp'     ,
+                    'co2_flux_wtr' , 'co2_flux_ice' , 'co2_flux_lnd' ,
+                    'fco2nat'
 /
 EOF
 fi
 
 
 if [[ "$output_phy_3d" == "yes" ]]; then
   #
   cat >> ${atm_namelist} << EOF
 &output_nml
  output_filename  = "${EXPNAME}_phy_3d"
@@ -1197,21 +1242,23 @@
 
 ocean_vertical_levels=40
 ocean_grid_name="icon_grid_${ocean_gridID}_${ocean_refinement}_O"
 ocean_grid=${ocean_grid_name}.nc
 ocean_grid_folder="/pool/data/ICON/grids/public/mpim/${ocean_gridID}"
 ocean_data_InputFolder="/pool/data/ICON/oes/input/r0004/${ocean_grid_name}"
 
 #-----------------------------------------------------------------------------
 # HAMOCC
 #
-use_hamocc=no
+
+use_hamocc=yes
+
 
 if [  "x${use_hamocc}"  = "xyes" ]; then
 lhamocc=".TRUE."
 lbgcadv=".TRUE."
 nlev_eu=$ocean_vertical_levels
 # set nlev_eu to level belonging to approx 500m
 if [ "x$ocean_vertical_levels" = "x40" ];then
 nlev_eu=19
 fi
 if [ "x$ocean_vertical_levels" = "x64" ];then
@@ -1495,21 +1542,21 @@
   filetype         =  4                       ! output format: 2=GRIB2, 4=NETCDFv2
   filename_format  = "<output_filename>_<datetime2>"
   output_filename  = "${EXPNAME}_hamocc_2d_tendencies"
   output_start     = "${start_date}"                  ! start in ISO-format
   output_end       = "${end_date}"                    ! end in ISO-format
   output_interval  = "${hamocc_output_interval}"
   mode             =  1                             ! 1: forecast mode (relative t-axis), 2: climate mode (absolute t-axis)
   file_interval    = "${hamocc_file_interval}"
   output_grid      = .TRUE.
   operation        = 'mean'
-  ml_varlist       =  'HAMOCC_co2flux','HAMOCC_orginp','HAMOCC_dmsflux','HAMOCC_silinp','HAMOCC_calinp','HAMOCC_o2flux','HAMOCC_n2flux','HAMOCC_n2oflux','HAMOCC_nfix_diag','HAMOCC_coex90','HAMOCC_calex90','HAMOCC_opex90','HAMOCC_coex1000','HAMOCC_opex1000','HAMOCC_calex1000','HAMOCC_coex2000','HAMOCC_opex2000','HAMOCC_calex2000','HAMOCC_o2min','HAMOCC_zo2min'
+  ml_varlist       =  'HAMOCC_co2flux','HAMOCC_orginp','HAMOCC_dmsflux','HAMOCC_silinp','HAMOCC_calinp','HAMOCC_o2flux','HAMOCC_n2flux','HAMOCC_n2oflux','HAMOCC_nfix_diag','HAMOCC_coex90','HAMOCC_calex90','HAMOCC_opex90','HAMOCC_coex1000','HAMOCC_opex1000','HAMOCC_calex1000','HAMOCC_coex2000','HAMOCC_opex2000','HAMOCC_calex2000','HAMOCC_o2min','HAMOCC_zo2min', 'co2mr'
 /
 EOF
 fi
 fi
 ##############################################################
 
 cat >> ${oce_namelist} << EOF
 &dbg_index_nml
   idbg_mxmn                  = 1                                ! initialize MIN/MAX  debug output
   idbg_val                   = 0                                ! initialize one cell debug output
@@ -1625,21 +1672,21 @@
  leadclose_1                                = 0.25        ! default: 0.5 - value of MPIOM: 0.25
  leadclose_2n                               = 0.666       ! default: 0.0 - value of MPIOM: 2/3
 /
 EOF
 
 ## HAMOCC namelist ########################################
 if [  "x${use_hamocc}"  = "xyes" ]; then
 cat >> ${oce_namelist} << EOF
 &hamocc_nml
 l_cyadyn                          = .TRUE.    ! dynamic cyanobacteria
-l_cpl_co2                         = .FALSE.   ! CO2 coupled to land carbon cycle
+l_cpl_co2                         = .TRUE.   ! CO2 coupled to land carbon cycle
 l_bgc_check                       = .FALSE.   ! mass check at every time step
 deltacalc                         = 0.0        ! CaCO3 weathering rate [kmol/s] 
 deltaorg                          = 0.0        ! OC weathering rate [kmol/s]
 deltasil                          = 0.0        ! Si(OH)4 weathering rate [kmol/s]
 atm_co2                           = 284.3      ! atmospheric CO2 (default 278)
 atm_n2                            = 802000.   ! atmospheric N2  (default 802000)
 atm_o2                            = 196800.   ! atmospheric O2  (default 196800)
 sinkspeed_opal                    = 25.       ! opal sinking speed [m/d] (default 30)
 sinkspeed_calc                    = 30.       ! calc sinking speed [m/d] (default 30)
 i_settling                        = 1         ! 0 constant POC sinking speed, 1 Martin curve, 2 AGG module (not yet implemented)
