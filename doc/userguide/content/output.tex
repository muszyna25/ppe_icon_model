\chapter{Output}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Progression Bar
% |==> |
% empty chapter chapter finished
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


In general the user has to specify six individual quantities to generate output of the model. These are:

\begin{enumerate}
\item{The time interval between two model outputs.}
\item{The name of the output file.}
\item{The name of the variable.}
\item{The type of the vertical output grid (e.g. pressure levels or model levels).}
\item{The type of the horizontal output grid (e.g. ICON grid or geographical coordinates).}
\end{enumerate}

ICON offers the possibility to write groups of variables. 
In the following we will present two examples to demonstrate the options the user has to prescribe these quantities. A detailed description of all namelist parameters available to organize the output is described  in \verb+io_nml+ in the namelist section.

\subsubsection{Example 1}

We will begin with an individual variable which is written in NETCDF format on pressure levels and is interpolated to a horizontally regular lat-long grid:

\begin{Verbatim}[frame=single]
NAMELIST EXAMPLE
&io_nml
 filetype                  =  4   ! output format: 2=GRIB2, 4=NETCDFv2
 dom                       =  1   ! write output for domain 1
 output_bounds             =  0., 1.E7, 3600. ! start, end, interval in s.
 steps_per_file            =  50  ! max. num. of time steps within one file
 mode                      =  1   ! 1: forecast mode (relative t-axis)
 include_last              = .TRUE. ! include the last time step
 output_filename           = '<INSERTFILENAME>' ! file name base
 pl_varlist                = 'geopot' ! name of pressure level field
 remap                     = 1   ! output is transferred to lat long grid
 reg_lon_def               = 0.,0.5,359.5   !start, incr., end, in deg.
 reg_lat_def               = 90.,-0.5, -90. !start, incr., end, in deg.
\end{Verbatim}




\subsubsection{Example 2}

The flexibility of the options ICON offers is demonstrated in another example. Now we apply an alternative to define the runtime of ICON, write several variables, at the same time, in one data set, on model levels, and on the original horizontal grid of ICON. In addition the example below shows the options when several model domains run at the same time and we want to produce output for all model domains.

\begin{Verbatim}[frame=single]
NAMELIST EXAMPLE
&output_nml
 dom                          =  -1 ! write all domains
 steps_per_file               =  5  ! max. num. of time steps within
  output_start     = "1978-01-01T00:00:00Z" ! ISO-format date+time
  output_end       = "1979-01-02T00:00:00Z" ! ISO-format date+time
  output_interval  = "PT01H"                ! ISO-format interval
  file_interval    = "PT01D"                ! ISO-format interval
  include_last     = .FALSE.
  output_filename              = '<INSERTFILENAME>'    ! file name base
  ml_varlist='u', 'group:precip_vars' ! Indiv. variable and variable group
  output_grid      = .TRUE. ! Output on the ICON horizontal grid
\end{Verbatim}

\subsubsection{Variable groups}
Next we explain the meaning of variable groups.
Using the \texttt{"group:"} keyword for the namelist parameters \texttt{ml\_varlist}, \texttt{hl\_varlist}, \texttt{pl\_varlist},
sets of common variables can be added to the output.


There exists a special syntax which allows to remove variables from the output list, e.\,g.\ if
these undesired variables were contained in a previously selected group.\\
Typing \texttt{"-<varname>"} (for example \texttt{"-temp"}) removes the
variable from the union set of group variables and other selected variables.Note that typos are not detected but that the corresponding variable is simply not removed!



\subsubsection{How to find variable names and contents of variable groups}

Finding the correct names of the variables you may want to write to a data set is not an easy task and you should be aware of some pitfalls. We will help you to avoid the most obvious ones. First of all users that have already experience with the COSMO model should know that the names of the atmospheric variables in ICON are \textbf{not identical}. 

The easiest way to identify the correct names of the variables you would like to write is to look into the following data sets:

\begin{Verbatim}[frame=single]
atm_dyn_iconam/mo_nonhydro_state.f90
atm_phy_nwp/mo_nwp_phy_state.f90
lnd_phy_nwp/mo_nwp_lnd_state.f90
\end{Verbatim}

Now you may want to use the option of writing groups of variables and of course you may want to know which variable belongs to which group.
Keep in mind that there is an option mentioned before to remove variables from the output of a group of variables.

The following table gives overview on the allocation of variables to individual variable groups. If you want to translate the Fortran variables to the physical or mathematical ones again have a look to the Fortran files listed above.

\begin{Verbatim}[frame=single]
******************************
	nh_prog_vars
vn
rho
theta_v
exner
******************************
	dwd_fg_atm_vars
vn
w
rho
theta_v
tke
u
v
pres_sfc
temp
pres
z_ifc
t_2m
td_2m
u_10m
v_10m
******************************
	mode_dwd_fg_in
vn
w
rho
theta_v
tke
t_g
t_mnw_lk
t_wml_lk
h_ml_lk
t_bot_lk
c_t_lk
t_b1_lk
h_b1_lk
qv_s
w_i
w_so_ice
w_snow
rho_snow
t_snow_mult
rho_snow_mult
wliq_snow
wtot_snow
dzh_snow
gz0
******************************
	atmo_ml_vars
w
tke
u
v
temp
pres
******************************
	atmo_pl_vars
w
tke
u
v
temp
******************************
	atmo_z1_vars
w
tke
u
v
temp
pres
******************************
	mode_dwd_ana_in
u
v
temp
pres
t_ice
h_ice
fr_seaice
w_so
t_snow
h_snow
freshsnow
******************************
	atmo_derived_vars
omega
div
vor
******************************
	land_vars
t_g
qv_s
w_i
w_p
w_s
t_so
w_so
w_so_ice
t_snow
w_snow
rho_snow
snowfrac
******************************
	dwd_fg_sfc_vars
t_g
t_ice
h_ice
fr_seaice
w_i
t_so
w_so
w_so_ice
t_snow
w_snow
rho_snow
h_snow
freshsnow
t_snow_mult
rho_snow_mult
wliq_snow
wtot_snow
dzh_snow
gz0
******************************
	mode_combined_in
t_g
t_ice
h_ice
qv_s
fr_seaice
w_i
w_so
t_snow
w_snow
rho_snow
h_snow
freshsnow
******************************
	mode_cosmode_in
t_g
t_ice
h_ice
qv_s
w_i
w_so
t_snow
w_snow
rho_snow
h_snow
freshsnow
******************************
	dwd_fg_scf_vars	
t_mnw_lk 
t_wml_lk  
h_ml_lk  
t_bot_lk  
c_t_lk 
t_b1_lk  
h_b1_lk 
qv_s
******************************
	land_tile_vars
t_g_t
t_s_t
w_i_t
w_p_t
w_s_t
t_so_t
w_so_t
w_so_ice_t
t_snow_t
w_snow_t
rho_snow_t
t_snow_mult_t
wtot_snow_t
wliq_snow_t
rho_snow_mult_t
dzh_snow_t
qv_s_t
h_snow_t
snowfrac_t
snowfrac_lc_t
******************************
	snow_vars
t_snow
rho_snow
wliq_snow
wtot_snow
dzh_snow
******************************
	multisnow_vars
t_snow_mult
rho_snow_mult
wliq_snow
wtot_snow
dzh_snow
******************************
	precip_vars

rain_gsp
snow_gsp
rain_con
snow_con
ice_gsp
graupel_gsp
hail_gsp
tot_prec
******************************
	additional_precip_vars
con_prec_rate_avg 
gsp_prec_rate_avg
cape
clct
tot_cld_vi
******************************
	pbl_vars
gust
shfl_s
lhfl_s
lhfl_bs
lhfl_pl
ghfl_s
tcm
tch
t_2m 
qv_2m
td_2m  
u_10m  
v_10m 
tkvm
tkvh
******************************
	cloud_diag
clc
gc_dia
gi_dia
tot_cld
******************************
	rad_vars
thb_s
sod_t
sou_t
sod_s
sou_s
thd_s
thu_s
sodird_s
sodifd_s
sodufu_s
albdif
albvisdiff
albnirdiff
sob_s_t
thb_s_t
flxdwswtoa
sob_s
sob_t
******************************
	phys_tendencies
ddt_temp_radsw
ddt_temp_radlw
ddt_temp_turb
ddt_temp_drag
ddt_u_turb
ddt_u_sso
ddt_u_gwd
ddt_v_turb
ddt_v_sso
ddt_v_gwd: 
******************************
	prog_timemean
temp_m
rho_m
u_m
v_m
pres_sfc_m
pres_msl_m
******************************
	echam_timemean
cosmu0_m
flxdwswtoa_m
aclcov_m
rsfl_m
rsfc_m
ssfl_m
ssfc_m
totprec_m
qvi_m
xlvi_m
xivi_m
swflxsfc_m
swflxtoa_m
lwflxsfc_m
lwflxtoa_m
tsfc_m
evap_m
lhflx_m
shflx_m
u_stress_m
v_stress_m
******************************
	tracer_timemean
qc_m
qv_m
qi_m
******************************
	atmo_timemean
all vars of prog_timemean, echam_timmean, tracer_timemean
\end{Verbatim}

 

\subsubsection{Data format}


ICON offers the possibility to produce output either in NETCDF or GRIB2 format. This can be chosen by the namelist parameter \verb+filetype+ of the namelist \verb+&output_nml+. New users are suggested to set \verb+filetype=4+ in order to use NETCDF output.

In GRIB2, a variable is uniquely defined by the following set of metadata:
\begin{itemize}
 \item \textit{Discipline} (see GRIB2 code table 4.2)
 \item \textit{ParameterCategory} (see GRIB2 code table 4.2)
 \item \textit{ParameterNumber} (see GRIB2 code table 4.2)
 \item \textit{typeOfFirstfixedSurface} and \textit{typeOfSecondFixedSurface} (see GRIB2 code table 4.5)
 \item \textit{stepType} (instant, accum, avg, max, min, diff, rms, sd, cov, \dots)
\end{itemize}
A documentation of the official WMO GRIB2 code tables can be found on the website of WMO: \\ \href{http://www.wmo.int/pages/prog/www/WMOCodes/WMO306_vI2/LatestVERSION/WMO306_vI2_GRIB2_CodeFlag_en.pdf} {http://www.wmo.int/pages/prog/www/WMOCodes/ \\ WMO306\_vI2/LatestVERSION/WMO306\_vI2\_GRIB2\_CodeFlag\_en.pdf}.\\



\subsubsection{Time stamp format}


The namelist parameters \texttt{output\_start}, \texttt{output\_end}, \texttt{output\_interval} allow
the specification of time stamps according to ISO 8601.
The general format for time stamps is \texttt{YYYY-MM-DDThh:mm:ss}
where \texttt{Y}: year, \texttt{M}: month, \texttt{D}: day for dates, 
and   \texttt{hh}: hour, \texttt{mm}: minute, \texttt{ss}: second for time strings.  
The general format for durations is \texttt{PnYnMnDTnHnMnS}.
See, for example, \texttt{http://en.wikipedia.org/wiki/ISO\_8601} for details and further specifications.

\color{red}NOTE: as the mtime library underlaying the output driver
  currently has some restrictions concerning the specification of durations:\begin{enumerate}
\item Any number \texttt{n} in \texttt{PnYnMnDTnHnMnS} must have two digits. For instance use \texttt{"PT06H"} instead of \texttt{"PT6H"}
\item In a duration string \texttt{PnyearYnmonMndayDTnhrHnminMnsecS} the numbers \texttt{nxyz} must not pass the carry over number to the next larger time unit: 0$<$=nmon$<$=12, 0$<$=nhr$<$=23, 0$<$=nmin$<$=59, 0$<$=nsec$<$=59.999. For instance use \texttt{"PT01D"} instead of \texttt{"PT24H"}, or \texttt{"PT01M"} instead of \texttt{"PT60S"}.
\end{enumerate}

Soon the formatting problem will be resolved and the valid number ranges will be enlarged.
(2013-12-16).\color{black}



\subsubsection{Extra output}


\begin{enumerate} 
\item In the namelist {\bf \texttt{run\_ctl}} set the number of fields with \texttt{inextra\_2d} or
  \texttt{inextra\_3d}. The logical variable for output
  \texttt{lwrite\_extra} then will be set automatically. Note, the
  number of extra fields is limited by $9$ each for 2D and 3D.
\item  \texttt{USE} these variables in the module needed.
\item Implement the storage of wished fields by using the
  nonhydrostatic diagnostic type with
  \texttt{p\_diag\%extra\_2d/3d}. 
\end{enumerate} 

Example for the use of  \texttt{p\_diag\%extra\_2d}:  

\begin{small}
\begin{verbatim}
  USE mo_global_variables, ONLY: inextra_2d
...
  DO jc = i_startidx, i_endidx
p_diag\%extra_2d(jc,jb,1)= yxz(jc,jb)
  ENDDO
\end{verbatim}
\end{small}


\subsubsection*{Asynchronous output:}
It is highly recommended that the asynchronous output option of ICON is applied. In short
this option reserves a number of processors for output only. While writing the remaining
processors continuously carry out calculations. Otherwise they would have to wait until
output is finished. The corresponding namelist parameter is:

\begin{verbatim}
&parallel_nml
num_io_procs = n
\end{verbatim}

n is the number of processors used for output.


\subsubsection{Time mean output:}
The builtin functionality for getting time-averaged output fields has the following features and limitations
\begin{itemize}
  \item The list of variables is configurabe via \texttt{output\_nml} like the regular instantaneous
  \item There can be multiple mean values intervals for the same variable, but only one interval per file
  \item 2d and 3d Variables are supported
  \item output is limited to model level
  \item nesting is not supported
  \item GRIB output is not supported
  \item Output interval has to be a divisor of the restart interval, because the intermediate accumulation results are not saved
  \item The output for the initial timestep of the time mean variables is zero.
\end{itemize}

\paragraph{Example Usage}

For getting 6-hourly averaged output, two namelist variable of \texttt{output\_nml} has to be set up:

\begin{itemize}
  \item \texttt{output\_interval = "PT06H"}
  \item \texttt{operation = "mean"}
\end{itemize}

If daily mean values should be created in addition, a new \texttt{output\_nml} has to be defined for a new output file with
\texttt{output\_interval = "P1D"}.


\subsection*{Discussion}
%This sction is for discussion only. Please add your notes, your name and date.
Document last edited by \textit{\krauti} on \textit{29.11.2013}\\
Document last edited by \textit{S Gruber} on \textit{08-01-2014}\\
Document last edited by \textit{B Vogel} on \textit{27-05-2014}\\
Document last edited by \textit{B Vogel} on \textit{30-06-2014}\\
Document last edited by \textit{\ram} on \textit{26-03-2015}\\
Document last edited by \textit{\ram} on \textit{07-02-2017}\\
