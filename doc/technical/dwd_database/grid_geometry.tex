\chapter{Grid geometry}

\section{Horizontal grid}
The horizontal ICON grid consists of a set of spherical triangles that seamlessly span the entire sphere. The grid is constructed from an icosahedron (see Figure 
\ref{fig_ico_a}) which is projected onto a sphere. The spherical icosahedron (Figure \ref{fig_ico_b}) consists of $20$ equilateral spherical triangles. The edges of each triangle 
are bisected into equal halves or more generally into $n$ equal sections. Connecting the new edge points by great circle arcs yields $4$ or more generally $n^2$ spherical triangles 
within the original triangle (Figure \ref{fig_bisect}, \ref{fig_nsect}). 

\begin{figure}[h]
  \begin{minipage}[b]{0.4\textwidth}
    \centering
    \includegraphics[width=0.7\textwidth]{icosahedron.png}
    \subcaption{}\label{fig_ico_a}
  \end{minipage}\hfill
  \begin{minipage}[b]{0.4\textwidth}
    \centering
    \includegraphics[width=0.7\textwidth]{icosahedron_spherical.png}
    \subcaption{}\label{fig_ico_b}
  \end{minipage}\hfill
  \caption{Icosahedron before (a) and after (b) projection onto a sphere }
\end{figure}

\begin{figure}[h]
  \begin{minipage}[b]{0.4\textwidth}
    \centering
    \includegraphics[width=0.7\textwidth]{bisection.png}
    \subcaption{}\label{fig_bisect}
  \end{minipage}\hfill
  \begin{minipage}[b]{0.4\textwidth}
    \centering
    \includegraphics[width=0.8\textwidth]{nsection.png}
    \subcaption{}\label{fig_nsect}
  \end{minipage}\hfill
  \caption{(a) Bisection of the original triangle edges (b) More general division into $n$ equal sections}
\end{figure}

ICON grids are constructed by an initial root division into $n$ sections (\textbf{R}n) followed by $k$ bisection steps (\textbf{B}k), resulting in a \textbf{R}n\textbf{B}k grid. 
Figures \ref{fig_R2B00} and \ref{fig_R2B02} show \textbf{R}2\textbf{B}00 and \textbf{R}2\textbf{B}02 ICON grids. Such grids avoid polar singularities of latitude-longitude grids 
(Figure \ref{fig_lonlat}) and allow a high uniformity in resolution over the whole sphere.

\begin{figure}[h]
  \begin{minipage}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{icon_grid_R2B00.png}
    \subcaption{}\label{fig_R2B00}
  \end{minipage}\hfill
  \begin{minipage}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{icon_grid_R2B02.png}
    \subcaption{}\label{fig_R2B02}
  \end{minipage}\hfill
  \begin{minipage}[b]{0.3\textwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{lon-lat-grid.png}
    \subcaption{}\label{fig_lonlat}
  \end{minipage}\hfill
  \caption{(a) R2B00 grid. (b) R2B02 grid. (c) traditional regular latitude-longitude grid with polar singularities}
\end{figure}

Throughout this document, the grid is referred to as the ``\textbf{R}n\textbf{B}k grid'' or ``\textbf{R}n\textbf{B}k resolution''. For a given resolution \textbf{R}n\textbf{B}k, 
the total number of cells, edges, and vertices can be computed from
\begin{eqnarray*}
 n_{c} &=& 20\,n^{2}\,4^{k} \\
 n_{e} &=& 30\,n^{2}\,4^{k} \\
 n_{v} &=& 10\,n^{2}\,4^{k} + 2
\end{eqnarray*}
The average cell area $\overline{\Delta A}$ can be computed from
\begin{align*}
 \overline{\Delta A} = \frac{4\pi\,r_{e}^{2}}{n_{c}}\,,
\end{align*}
with the earth radius $r_{e}$, and $n_{c}$ the total number of cells. Based on $\overline{\Delta A}$ one can derive an estimate of the average grid resolution 
$\overline{\Delta x}$:
\begin{align*}
 \overline{\Delta x} = \sqrt{\overline{\Delta A}} = \sqrt{\frac{\pi}{5}} \frac{r_{e}}{n\,2^{k}}
\end{align*}
Visually speaking, $\overline{\Delta x}$ is the edge length of a square which has the same area as our triangular cell.


In Table \ref{tab_res}, some characteristics of frequently used ICON grids are given. The table contains information about the total number of triangles ($n_{c}$), the average 
resolution $\overline{\Delta x}$, and the maximum/minimum cell area. The latter may be interpreted as the area for which the prognosed meteorological quantities (like temperature, 
pressure, \dots) are representative. Some additional information about ICON's horizontal grid can be found in \citet{Wan13}.

\begin{table}[H]
  \caption{Characteristics of frequently used ICON grids. $\Delta A_{max}$ and $\Delta A_{min}$ refer to the maximum and minimum area of the grid cells, respectively.}\label{tab_res}
  \begin{center}
    \begin{tabular}{p{2.0cm}>{\raggedleft\arraybackslash}p{3.5cm}>{\centering\arraybackslash}p{3.5cm}>{\raggedleft\arraybackslash}p{2.5cm}>{\raggedleft\arraybackslash}p{2.5cm}}
    \toprule
    \textbf{Grid} & \textbf{number of cells ($n_{c}$)} & \textbf{avg.\ resolution [km]} & $\mathbf{\Delta A_{max}\,[km^{2}]}$ & $\mathbf{\Delta A_{min}\,[km^{2}]}$\\
    \midrule
    R2B04         &    20480                           &  157.8                         &  25974.2                  &  18777.3 \\
    R2B05         &    81920                           &   78.9                         &  6480.8                   & 4507.5\\
    R2B06         &   327680                           &   39.5                         &  1618.4                   & 1089.6 \\
    R2B07         &  1310720                           &   19.7                         &  404.4                    & 265.1 \\
    R3B07         &  2949120                           &   13.2                         &  179.7                    & 116.3 \\
    \bottomrule
    \end{tabular}
  \end{center}
\end{table}

\paragraph{}
\textbf{\textcolor{red}{The first operational version of ICON will most likely be based on the R3B07 grid, thus, having a horizontal resolution of about $13\,\mathrm{km}$!}}

\subsection{Local grid refinement}



\section{Vertical grid}

The vertical grid consists of a set of vertical layers with height-based vertical coordinates.
Each of these layers carries the horizontal $2D$ grid structure, thus forming the $3D$ structure of the grid.
The ICON grid employs a Lorenz-type staggering with the vertical velocity defined at the boundaries of layers (half levels) 
and the other prognostic variables in the center of the layer (full levels).

To improve simulations of flow past complex topography, the ICON model employs a smooth level vertical (SLEVE) coordinate~\citet{Leuenberger2010}.
The required smooth large-scale contribution of the model topography is generated by digital filtering with a $\nabla^2$-diffusion operator.
Figure~\ref{fig:vertical_levels} shows the (half) levels of the current (preliminary) ICON setup with 90 vertical levels.



% ---------------------------------------------------------------------------------------
% ICON vertical levels -- SLEVE coordinates
% 
% author: 07/2013: F. Prill, DWD
% created with a Matlab script and the following settings:
%
%   min_lay_thckn   = 20.;        % Layer thickness of lowermost layer
%   top_height      = 75000.;     % Height of model top
%   stretch_fac     = 0.9;        % Scaling factor for stretching/squeezing 
%                                 % the model layer distribution
%   
%   decay_scale_1   = 4000.;      % Decay scale of large-scale topography component
%   decay_scale_2   = 2500.;      % Decay scale of small-scale topography component
%   decay_exp       = 1.2;        % Exponent for decay function
%   flat_height     = 16000.;     % Height above which the coordinate surfaces are flat
%   topo            = 0.;
%   topo_smt        = 0.;  
% 
% see also ICON routines "init_sleve_coord", "init_vert_coord"        
%
% Input files for this figure are created with the following commands:
%
%  octave -q --eval 'nlev=90; [z_m, z_i, pres_m, pres_i] = icon_levels(nlev); printf("k z p\n"); for k=1:nlev printf("%d %5.3f %5.3f\n",k,z_i(k),z_i(k)-z_i(k+1));end' > vertical_levels_i.txt 
%
%  octave -q --eval 'nlev=90; [z_m, z_i, pres_m, pres_i] = icon_levels(nlev); printf("k z p\n"); for k=[1:5:nlev,nlev] printf("%d %d %5.1f\n",k,z_i(k),pres_i(k));end' > vertical_levels_i_small.txt 
%
% (Alternatively, for a pressure plot:)
%  octave -q --eval 'nlev=90; [z_m, z_i, pres_m, pres_i] = icon_levels(nlev); printf("k z p\n"); for k=1:nlev printf("%d %5.3f %5.3f\n",k,z_i(k),pres_i(k));end' > vertical_levels_i.txt 
%
%
% ---------------------------------------------------------------------------------------
\begin{figure}[hb]
\subfloat{
  \begin{minipage}[t]{0.65\linewidth} \vspace*{0pt}%
    \pgfplotstableread{vertical_levels_i.txt}{\loadedtable}
    \pgfplotsset{
      tick label style={font=\small},
    }
  \begin{tikzpicture}[scale=0.7, transform shape]
    \begin{axis}[ minor tick num=1, axis x line=bottom, axis y line=left, 
                  every inner x axis line/.append style= {|->},
                  every inner y axis line/.append style= {|->}, 
                  width=10cm,height=14.5cm, ymajorgrids,
                  xlabel=level, 
                  scaled y ticks = false,
                  ylabel=\textbf{\color{blue}$z~\text{[m]}$}, enlargelimits=false,
                  every axis y label/.style={at={(current axis.north west)},
                                             yshift=3em,anchor=north east}
                ]
      \addplot[blue,mark=*] table[x={k},y={z}] \loadedtable;
    \end{axis}
    \begin{axis}[ minor tick num=1, axis x line=bottom, axis y line=right, 
                  every inner x axis line/.append style= {|->},
                  every inner y axis line/.append style= {|->}, 
                  width=10cm,height=14.5cm, 
                  scaled y ticks = false,
                  ylabel=\textbf{\color{red}$\Delta z~\text{[m]}$}, enlargelimits=false ,
                  every axis y label/.style={at={(current axis.north east)},
                                             yshift=3em,anchor=north west}
                 ]
      \addplot[red,only marks,mark=diamond] table[x={k},y={p}] \loadedtable;
    \end{axis}
  \end{tikzpicture}
  \end{minipage}
  }
  \subfloat{
  \begin{minipage}[t]{0.35\linewidth}\vspace*{0em}%
   \renewcommand{\baselinestretch}{0.95}\normalsize%
   \pgfkeys{/pgf/number format/set thousands separator={\,}}
   \pgfplotstableread{vertical_levels_i_small.txt}{\loadedtablesmall}\vspace*{0pt}%
   \pgfplotstabletypeset[ columns={k,z,p},every  head row/.style={after row={\hline}},
          font=\footnotesize,
          columns/k/.style={column name=$level$, column type=r,column type/.add={>{\columncolor[gray]{.8}}}{}},
          columns/z/.style={column name=$[m]$,   fixed,dec sep align},
          columns/p/.style={column name=$[Pa]$, fixed,dec sep align, zerofill,precision=1},
                        ] {\loadedtablesmall}
    \vspace*{1em}%
  \end{minipage}
  }
  \caption{Vertical levels of the ICON model (preliminary setup).
           The table of selected pressure values (for zero height) is based on the 1976 US standard atmosphere.}
  \label{fig:vertical_levels}%
\end{figure}