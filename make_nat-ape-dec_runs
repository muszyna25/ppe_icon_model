#!/bin/bash

#==============================================================================
# Creates the ICON run scripts
# Leonidas Linardakis, MPI-M, 2011-25-1
#==============================================================================
#==============================================================================
# The basic command for creating an ICON experiment run script is
#   
#  $make_runscript in_script=exp.<name> in_script=exec.iconrun EXPNAME=<name>
#
# By default the folder in use is ./run, and the run script is named exp.<name>.run.
# 
# Basic optional parameters for the $make_runscript command are:
#
#    out_script=<output run script name>. By default is <in_script>.run
#
#    in_folder=<input folder>. By default is run
#
#    out_folder=<output folder>. By default is =<in_folder>
#
#    mpi_procs=<number of mpi processes>. In the case of MPI configuration,
#       defines how many processes per node will be used.
# 
#    no_of_nodes=<Number of nodes>. In the case of MPI configuration,
#       defines how many nodes will be used.
# 
#    openmp_threads=<Number of openmp threads>. In the case of OPENMP
#       configuration, defines how many OPENMP threads will be used.
#
#    cpu_time=<wall time>. Defines the expected run wall time.
#  
#    <free_variable>=<value> Free variables can be passed to the run script
#       using this syntax. For example: EXPNAME=test, will result the
#       definition of the variable EXPNAME=test in the run script. 
   

#
# For more details see the parameters in the ./config/make_target_runscript
#==============================================================================
set -x
echo "-----------------------------------------------------------"
base_folder=$(pwd)
input_folder=run
#==============================================================================
. $base_folder/config/set-up.info
use_shell=${use_shell:="/bin/ksh"}
# The $make_runscript command directs to the ./config/make_target_runscript
make_runscript="$use_shell ./config/make_target_runscript"

#==============================================================================
create_dec()
{
#setup for blizzard
mpi_procs=16
mod=`expr ${dec_size} % ${mpi_procs}`
if [ $mod -eq 0 ] ; then
  nodes=`expr ${dec_size} / ${mpi_procs}`
else
  nodes=`expr ${dec_size} / ${mpi_procs} + 1`
fi

#note that mpi_procs change on tornado
if [ $use_target = "tornado" ] ; then
  mod=`expr ${dec_size} % 8`
  if [ $mod -eq 0 ] ; then
    nodes=`expr ${dec_size} / 8`
  else
    nodes=`expr ${dec_size} / 8 + 1`
  fi
  mpi_procs=`expr ${nodes} \* 8`
  nodes
fi

exp_name=${outname}.${dec_size}.${nodes}nodes
runname=exp.${exp_name}.run

$make_runscript in_folder=$input_folder in_script=exp.$name in_script=exec.iconrun EXPNAME=${exp_name} out_script=${runname} \
atmo_dyn_gridname="$atmo_dyn_gridname" atmo_rad_gridname="$atmo_rad_gridname" nproma=$nproma no_of_nodes=$nodes dec_size=$dec_size dt_rad=$dt_rad \
mpi_procs=$mpi_procs openmp_threads=4 cpu_time=$cpu_time use_barrier=$use_barrier testbed_mode=$testbed_mode division_method=$division_method \
ndays=$ndays
# queue="express"

if [ $run = "true" ]; then
  cd $input_folder
  $use_submit ${runname}
  cd $base_folder
fi

}
#==============================================================================

create_scaling_dec_lowres()
{
cpu_time="00:10:00"
ndays=16
outname="${outname}_lowres"

atmo_dyn_gridname='iconR2B04_dec-162'
if [ x$rrad = "xtrue" ]; then
  atmo_rad_gridname='iconR2B03_dec-162_rrad'
else
  atmo_rad_gridname=""
fi
dec_size=162
create_dec

atmo_dyn_gridname='iconR2B05_dec-642'
if [ x$rrad = "xtrue" ]; then
  atmo_rad_gridname='iconR2B04_dec-642_rrad'
else
  atmo_rad_gridname=""
fi
dec_size=642
create_dec

atmo_dyn_gridname='iconR2B06_dec-1082'
if [ x$rrad = "xtrue" ]; then
  atmo_rad_gridname='iconR2B05_dec-1082_rrad'
else
  atmo_rad_gridname=""
fi
dec_size=1082
create_dec
}


create_scaling_dec_hires()
{
cpu_time="00:20:00"
ndays=10
outname="${outname}_hires"

atmo_dyn_gridname='iconR2B05_dec-162'
if [ x$rrad = "xtrue" ]; then
  atmo_rad_gridname='iconR2B04_dec-162_rrad'
else
  atmo_rad_gridname=""
fi
dec_size=162
create_dec

atmo_dyn_gridname='iconR2B06_dec-642'
if [ x$rrad = "xtrue" ]; then
  atmo_rad_gridname='iconR2B05_dec-642_rrad'
else
  atmo_rad_gridname=""
fi
dec_size=642
create_dec

atmo_dyn_gridname='iconR2B07_dec-1082'
if [ x$rrad = "xtrue" ]; then
  atmo_rad_gridname='iconR2B06_dec-1082_rrad'
else
  atmo_rad_gridname=""
fi
dec_size=1082
create_dec
}

#==============================================================================

name=nat_ape-dec
#---------------------------------
run="true"
run="false"
use_barrier=".false."
testbed_mode=0
nproma=12
#==============================================================================
#=================================
rrad="true"
dt_rad=3600
nproma=4
#---------------------------------
division_method=0
outname=nat_ape-hexdec-rrad_1h_4nproma
create_scaling_dec_lowres
exit

division_method=1
outname=nat_ape-geomdec-rrad-1h
create_scaling_dec_hires


#---------------------------------
rrad="false"
dt_rad=1800
nproma=12
#---------------------------------
division_method=0
outname=nat_ape-hexdec_30min
create_scaling_dec_hires

division_method=1
outname=nat_ape-geomdec_30min
create_scaling_dec_hires


#==============================================================================
rrad="false"
dt_rad=1800
#---------------------------------
division_method=0
outname=nat_ape-hexdec_30min
create_scaling_dec_lowres

division_method=1
outname=nat_ape-geomec_30min
create_scaling_dec_lowres

exit

dt_rad=3600
outname=nat_ape-hexdec_1h
create_scaling_dec_lowres


#---------------------------------
division_method=1
dt_rad=3600
outname=nat_ape-geomdec_1h
create_scaling_dec_lowres

dt_rad=1800
outname=nat_ape-geomec_30min
create_scaling_dec_lowres

#==============================================================================
rrad="true"
#---------------------------------
division_method=0
dt_rad=3600
outname=nat_ape-hexdec-rrad_1h
create_scaling_dec_lowres

#---------------------------------
division_method=1
dt_rad=3600
outname=nat_ape-geomdec-rrad_1h
create_scaling_dec_lowres


exit

#==============================================================================

#==============================================================================


name=icon-testbed_communication-dec
run="true"
#---------------------------------
use_barrier=".false."
testbed_mode=0

division_method=0
outname=icon-testbed_communication-hexdec
create_scaling_dec_lowres

division_method=1
outname=icon-testbed_communication-geomdec
create_scaling_dec_lowres

exit


#==============================================================================

#==============================================================================
# special treatment for exp.icon-testbed_communication
# this includes the restart in the test_hat_jww-moist_cld-cnv-vdf_restart
#

run_script="true"

nodes_list=(  10 20 40 60 80 )
nproma_list=( 37 37 33 29 33 )
nodes_list_size=${#nodes_list[*]}

name=icon-testbed_communication

j=0
while [ $j -lt ${nodes_list_size} ]
do
  nodes=${nodes_list[$j]}
  nproma=${nproma_list[$j]}
 
  exp_name=${name}.${nodes}nodes
  runname=exp.${exp_name}.run
  $make_runscript in_folder=$input_folder in_script=exp.$name in_script=exec.iconrun EXPNAME=$exp_name out_script=$runname\
  grid="iconR2B06-grid.nc"  nproma=$nproma no_of_nodes=$nodes mpi_procs=16 openmp_threads=4 cpu_time="00:10:00"

  if [[ $run_script == "true" ]] ; then
     cd $input_folder
     $use_submit ./$runname
     cd ..
  fi

  let j=j+1
done
#==============================================================================

echo "-----------------------------------------------------------"
