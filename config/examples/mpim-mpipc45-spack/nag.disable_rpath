#!/bin/bash

set -eu

MY_DIR=$(cd "$(dirname "$0")"; pwd)
ICON_DIR="${MY_DIR}/../../.."

. "${MY_DIR}/init_nag_6.2.sh"

FC=$MPICH_FC
CC=$MPICH_CC

FCFLAGS="-mismatch -O2 -g ${NETCDFF_FCFLAGS}"
CFLAGS='-O2 -g'
CPPFLAGS="${HDF5_CPPFLAGS} ${NETCDF_CPPFLAGS} ${GRIBAPI_CPPFLAGS} ${XML2_CPPFLAGS}"
LDFLAGS="${HDF5_LDFLAGS} ${NETCDF_LDFLAGS} ${NETCDFF_LDFLAGS} ${GRIBAPI_LDFLAGS} ${BLAS_LDFLAGS} ${LAPACK_LDFLAGS} ${XML2_LDFLAGS}"
LIBS="${XML2_LIBS} ${LAPACK_LIBS} ${BLAS_LIBS} ${GRIBAPI_LIBS} ${NETCDFF_LIBS} ${NETCDF_LIBS} ${HDF5_LIBS}"
MPI_LAUNCH=$MPICH_LAUNCH

# In this example we show how to disable the RPATH magic implemented in the
# configure script. This can be useful if the user wants to have full control
# over the flags passed to the linker when linking ICON executable. Note that
# ICON executable is linked by Fortran compiler and C compiler is used for
# linking only by the configure scripts and test suites of the bundled
# libraries. At the same time, some of the bundled libraries (e.g. CDI) link
# Fortran code using libtool. This means that linker flags must be interpreted
# in the same way by the Fortran compiler and libtool. Unfortunately, this is
# not always possible because libtool is unable to process RPATH flags
# correctly when their prefixes differ from '-Wl,-rpath -Wl,' or '-Wl,-rpath,'.
# For example, the flags '-Wl,-Wl,,-rpath -Wl,-Wl,,<lib dir>', which are valid
# for NAG compiler, are incorrectly transformed by libtool into
# '-Wl,-Wl -Wl,"" -Wl,-rpath -Wl,-Wl -Wl,"" -Wl,<lib dir>'. A possible solution
# for this problem is to add RPATH flags in the form understood by NAG compiler
# not to LDFLAGS but to ICON_FCFLAGS and make sure that the bundled libraries,
# especially the libtool-based ones, will not receive them:

ICON_FCFLAGS="`echo ${LDFLAGS} | sed 's%-L[ ]*\([^ ][^ ]*\)%-Wl,-Wl,,-rpath -Wl,-Wl,,\1%g'`"
ICON_BUNDLED_FCFLAGS=

# Set LD_LIBRARY_PATH inside BUILD_ENV to enable the location of dynamic
# libraries at the configure time and when running 'make check':
BUILD_ENV="$BUILD_ENV LD_LIBRARY_PATH=\"`echo " ${LDFLAGS}" | sed -e 's/[ ][ ]*/ /g;s/-L[ ]/-L/g;s/[ ]\(-[^L]\|[^-]\)[^ ]*//g;s/[ ]*-L/:/g;s/^://'`:\$LD_LIBRARY_PATH\"; export LD_LIBRARY_PATH;"

"${ICON_DIR}/configure" \
BUILD_ENV="$BUILD_ENV" \
CC="$CC" \
CFLAGS="$CFLAGS" \
CPPFLAGS="$CPPFLAGS" \
FC="$FC" \
FCFLAGS="$FCFLAGS" \
ICON_BUNDLED_FCFLAGS="$ICON_BUNDLED_FCFLAGS" \
ICON_FCFLAGS="$ICON_FCFLAGS" \
LDFLAGS="$LDFLAGS" \
LIBS="$LIBS" \
MPI_LAUNCH="$MPI_LAUNCH" \
--disable-openmp \
--disable-rpaths \
--enable-grib2 \
--enable-sct \
"$@"

