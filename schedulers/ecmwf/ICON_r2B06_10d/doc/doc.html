<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>ecmwf_runs_documentation</title>
<meta name="generator" content="DokuWiki" />
<meta name="robots" content="noindex,nofollow" />
<meta name="date" content="2012-06-19T06:39:55+0000" />
<meta name="keywords" content="ecmwf_runs_documentation" />
<link rel="search" type="application/opensearchdescription+xml" href="/~fprill/wiki/lib/exe/opensearch.php" title="Wiki :: florian.prill@dwd.de" />
<link rel="start" href="/~fprill/wiki/" />
<link rel="contents" href="/~fprill/wiki/doku.php?id=ecmwf_runs_documentation&amp;do=index" title="Sitemap" />
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="/~fprill/wiki/feed.php" />
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="/~fprill/wiki/feed.php?mode=list&amp;ns=" />
<link rel="alternate" type="text/html" title="Plain HTML" href="/~fprill/wiki/doku.php?do=export_xhtml&amp;id=ecmwf_runs_documentation" />
<link rel="alternate" type="text/plain" title="Wiki Markup" href="/~fprill/wiki/doku.php?do=export_raw&amp;id=ecmwf_runs_documentation" />
<link rel="canonical" href="http://oflxs04.dwd.de/~fprill/wiki/doku.php?id=ecmwf_runs_documentation" />
<link rel="stylesheet" media="screen" type="text/css" href="/~fprill/wiki/lib/exe/css.php?t=drupal-garland-blue&amp;tseed=1327577588" />
<link rel="stylesheet" media="all" type="text/css" href="/~fprill/wiki/lib/exe/css.php?s=all&amp;t=drupal-garland-blue&amp;tseed=1327577588" />
<link rel="stylesheet" media="print" type="text/css" href="/~fprill/wiki/lib/exe/css.php?s=print&amp;t=drupal-garland-blue&amp;tseed=1327577588" />
<script type="text/javascript" ><!--//--><![CDATA[//><!--
var NS='';var JSINFO = {"id":"ecmwf_runs_documentation","namespace":""};
//--><!]]></script>
<script type="text/javascript" charset="utf-8" src="/~fprill/wiki/lib/exe/js.php?tseed=1327577588" ></script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div class="toc">
<div class="tocheader toctoggle" id="toc__header">Table of Contents</div>
<div id="toc__inside">

<ul class="toc">
<li class="level1"><div class="li"><span class="li"><a href="#documentation_-_scheduled_runs_of_the_icon_code_at_ecmwf" class="toc">Documentation - Scheduled runs of the ICON code at ECMWF</a></span></div>
<ul class="toc">
<li class="level2"><div class="li"><span class="li"><a href="#general_notes" class="toc">General Notes</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#sms_suite_icon_r2b06_10d" class="toc">SMS suite ICON_R2B06_10d</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#directory_layout" class="toc">Directory layout</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#suite_definition" class="toc">Suite definition</a></span></div></li>
</ul>
</li>
<li class="level2"><div class="li"><span class="li"><a href="#technical_infrastructure" class="toc">Technical infrastructure</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#setting_up_the_sms" class="toc">Setting up the SMS</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#rhosts" class="toc">.rhosts</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#svn_access" class="toc">SVN access</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#local_ruby_installation" class="toc">Local Ruby installation</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#local_cdo_installation" class="toc">Local CDO installation</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#grib_api_settings" class="toc">GRIB_API settings</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#local_settings" class="toc">Local settings</a></span></div></li>
</ul>
</li>
<li class="level2"><div class="li"><span class="li"><a href="#still_todo" class="toc">Still TODO</a></span></div></li></ul>
</li></ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1"><a name="documentation_-_scheduled_runs_of_the_icon_code_at_ecmwf" id="documentation_-_scheduled_runs_of_the_icon_code_at_ecmwf">Documentation - Scheduled runs of the ICON code at ECMWF</a></h1>
<div class="level1">

<p>

<em> Florian Prill, DWD. Document version: Phase 0 (Q2/2012) </em>
</p>

</div>
<!-- EDIT1 SECTION "Documentation - Scheduled runs of the ICON code at ECMWF" [1-135] -->
<h2 class="sectionedit2"><a name="general_notes" id="general_notes">General Notes</a></h2>
<div class="level2">

<p>

<strong>Case Setup “ICON_r2B06_10d”</strong>
</p>
<ul>
<li class="level1"><div class="li"> run time: 10 days</div>
</li>
<li class="level1"><div class="li"> time step size: 60 sec, 10*24*3600 / 60 = 14400 steps</div>
</li>
<li class="level1"><div class="li"> output every 3h = 10800 sec, 80 output actions</div>
</li>
</ul>

<p>

<strong>Restrictions</strong>
</p>
<ul>
<li class="level1"><div class="li"> Results are stored in a dedicated directory, not in a database</div>
</li>
<li class="level1"><div class="li"> IFS2ICON based on Ruby scripting language</div>
</li>
<li class="level1"><div class="li"> GRIB2 output available for plot suite, but still experimental</div>
</li>
</ul>

</div>
<!-- EDIT2 SECTION "General Notes" [136-524] -->
<h2 class="sectionedit3"><a name="sms_suite_icon_r2b06_10d" id="sms_suite_icon_r2b06_10d">SMS suite ICON_R2B06_10d</a></h2>
<div class="level2">

<p>

The ICON runs employ ECMWF&#039;s scheduler “SMS”, cf. <a href="http://www.ecmwf.int/publications/manuals/sms/" class="urlextern" title="http://www.ecmwf.int/publications/manuals/sms/"  rel="nofollow">http://www.ecmwf.int/publications/manuals/sms/</a>.

</p>
<ul>
<li class="level1"><div class="li"> Model is run by a dedicated user, <strong>”<code>deia</code>“</strong>.</div>
</li>
<li class="level1"><div class="li"> SMS files are stored in the Redmine <code>svn</code> version control system: <code>trunk/icon-dev/schedulers/ecmwf</code></div>
</li>
</ul>

<p>

The described scheduler setup for the ICON model is partly based on a similar script suite for BCeps (H. Frank, User <code>zde</code>), see
</p>
<pre class="code">     /home/ms/de/zde/BCeps/bceps.def</pre>

</div>
<!-- EDIT3 SECTION "SMS suite ICON_R2B06_10d" [525-1000] -->
<h3 class="sectionedit4"><a name="directory_layout" id="directory_layout">Directory layout</a></h3>
<div class="level3">

<p>

The SMS directory structure is necessary on the compute cluster file system, <code>$PERM</code> as well as on <code>ecgate</code>.

</p>
<ul>
<li class="level1"><div class="li"> The actual case setup for ICON is stored in the file <code>def/case_setup</code>.</div>
</li>
<li class="level1"><div class="li"> The SMS suite, i.e. the dependencies between the different tasks, is defined in <code>$HOME/ICON_R2B06_10d/def/smsfiles/icon.def</code></div>
</li>
<li class="level1"><div class="li"> All temporary SMS files are stored in <code>$HOME/sms_server</code> and <code>$HOME/sms</code>.</div>
</li>
<li class="level1"><div class="li"> Temporary results are stored in <code>$TMPDIR</code> on ecgate and <code>$TEMP/sms</code> on the cluster file system.</div>
</li>
</ul>

<p>
All script files and the model setup are located in a directory <code>$HOME/ICON_R2B06_10d</code>
of the following layout:

</p>
<pre class="code">$HOME/ICON_R2B06_10d
    def                    ! scripts for operating the suite
        smsfiles
        include
        icon_scripts       ! checkout from ICON SVN: trunk/icon-dev/scripts
        bin                ! additional script files
    output
        model              ! current model output
        log                ! SMS suite logfiles
    doc                    ! this documentation
    cluster                ! [only on compute cluster]
        icon-dev           ! latest build of SVN trunk [only on compute cluster]
        input              ! static input (time-independent)
            extpar
            grids
            radiation
            ifs2icon       ! model input from IFS
               cellweights
               config</pre>

<p>
<strong>Note:</strong>
Not all necessary contents are stored in the Redmine repository
</p>
<pre class="code"> https://svn.zmaw.de/svn/icon/trunk/icon-dev/schedulers/ecmwf/ICON_r2B06_10d</pre>

<p>
After the initial check-out one must add
</p>
<ul>
<li class="level1"><div class="li"> On <code>ecgate</code> and cluster <code>c1a</code>: <code>def/icon_scripts</code> (from <code><a href="https://svn.zmaw.de/svn/icon/trunk/icon-dev/scripts" class="urlextern" title="https://svn.zmaw.de/svn/icon/trunk/icon-dev/scripts"  rel="nofollow">https://svn.zmaw.de/svn/icon/trunk/icon-dev/scripts</a></code>)</div>
</li>
<li class="level1"><div class="li"> [On cluster:] Check-out of the ICON source code: <code>cluster/icon-dev</code></div>
</li>
</ul>

</div>
<!-- EDIT4 SECTION "Directory layout" [1001-2822] -->
<h3 class="sectionedit5"><a name="suite_definition" id="suite_definition">Suite definition</a></h3>
<div class="level3">

<p>

The complete run of the ICON model is split into different <em>tasks</em>. These tasks are grouped into <em>families</em> and <em>sub-families</em>, for example <em>init</em> and <em>init/build</em>.
Each task corresponds to a <code>*.sms</code> file, stored in the subdirectory <code>smsfiles/def/icon/…</code>, for example <code>smsfiles/def/icon/init/get_data.sms</code>. The <code>*.sms</code> files is an (almost) ordinary script file.
There a basically three types of <code>*.sms</code> files:
</p>
<ul>
<li class="level1"><div class="li"> Scripts running on <code>ecgate</code>: Post-processing etc.</div>
</li>
<li class="level1"><div class="li"> <code>hpc_serial</code>: Scripts running on the <code>c1a</code> frontend: Data retrieval for the cluster <code>c1a</code>.</div>
</li>
<li class="level1"><div class="li"> <code>hpc_parallel</code>: Scripts running in parallel on the compute cluster.</div>
</li>
</ul>

<p>

File names and output directories depend on two variables:
</p>
<ul>
<li class="level1"><div class="li"> <code>%SUITE_NAME%</code> <br/>
Currently set to “ICON_r2B06_10d”. Different suite names could later be used to perform several independent model runs.</div>
</li>
<li class="level1"><div class="li"> <code>$REQUEST_DATE</code> <br/>
The starting date for the forecast. Currently this is computed as %SMSDATE% - 2 days, time: UTC 00 </div>
</li>
</ul>

<p>
<a href="/~fprill/wiki/lib/exe/detail.php?id=ecmwf_runs_documentation&amp;media=pic_sms_icon.jpg" class="media" title="pic_sms_icon.jpg"><img src="/~fprill/wiki/lib/exe/fetch.php?w=200&amp;media=pic_sms_icon.jpg" class="media" title="Diagram of the ICON SMS suite" alt="Diagram of the ICON SMS suite" width="200" /></a>
</p>

</div>
<!-- EDIT5 SECTION "Suite definition" [2823-3908] -->
<h4 class="sectionedit6"><a name="task_ifs_fct_fct_ifs" id="task_ifs_fct_fct_ifs">Task ifs_fct/fct_ifs</a></h4>
<div class="level4">
<div class="table sectionedit7"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Dummy task, triggered by IFS, initiates ICON SMS suite. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1 leftalign"> <code>ecgate</code>                                              </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1 leftalign"> None.                                                   </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> None.                                                   </td>
	</tr>
</table></div>
<!-- EDIT7 TABLE [3939-4270] -->
<p>

The whole SMS suite is restarted (<code>repeat date</code> keyword) on a regular basis.
The suite contains an artificial dummy task, <code>fct_ifs</code>, whose completion is the starting condition for the whole suite.
</p>

<p>
There exists a small shell script <code>def/smsfiles/job.trigger</code> which is triggered by the IFS framework itself, i.e. via
</p>
<pre class="code"> ecaccess-job-submit</pre>

<p>
This shell script calls a CDP command:
</p>
<pre class="code"> force complete fct_ifs</pre>

<p>
and thus activates the whole ICON SMS suite.
</p>

<p>
Currently, the task is triggered by the <strong>event ID 167</strong>, which means “at this stage, the analysis at 00UTC is complete”.
The task has been registered with
</p>
<pre class="code"> ecaccess-job-submit -noDirectives -eventIds 167 -queueName ecgate $HOME/ICON_r2B06_10d/def/smsfiles/job.trigger </pre>

<p>
More events can be obtained from the list generated by the command
</p>
<pre class="code"> ecaccess-event-list </pre>

</div>
<!-- EDIT6 SECTION "Task ifs_fct/fct_ifs" [3909-5092] -->
<h4 class="sectionedit8"><a name="task_init_setup" id="task_init_setup">Task init/setup</a></h4>
<div class="level4">
<div class="table sectionedit9"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1 leftalign"> Set some initial variables and flags.                                    </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1 leftalign"> <code>ecgate</code>                                                               </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1 leftalign"> None.                                                                    </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1"> sets events “enable_build” and “enable_dumpstate” based on current date. </td>
	</tr>
</table></div>
<!-- EDIT9 TABLE [5118-5517] -->
</div>
<!-- EDIT8 SECTION "Task init/setup" [5093-5518] -->
<h4 class="sectionedit10"><a name="task_init_get_data" id="task_init_get_data">Task init/get_data</a></h4>
<div class="level4">
<div class="table sectionedit11"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Retrieve IFS data from MARS. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_serial</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1 leftalign"> None.                                                   </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Retrieved <code>*.grb</code> file is stored in <code>$PERM/%SUITE_NAME%/cluster/input/ifs2icon</code>  </td>
	</tr>
</table></div>
<!-- EDIT11 TABLE [5547-5839] -->
</div>
<!-- EDIT10 SECTION "Task init/get_data" [5519-5843] -->
<h4 class="sectionedit12"><a name="task_init_init_data" id="task_init_init_data">Task init/init_data</a></h4>
<div class="level4">
<div class="table sectionedit13"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Run converter <code>IFS2ICON</code>. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_serial</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> GRIB file stored in <code>$PERM/%SUITE_NAME%/cluster/input/ifs2icon</code> (moved by this task) </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1 leftalign"> IFS2ICON config file in <code>$PERM/%SUITE_NAME%/def/ifs2icon_1279.conf</code>  </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1 leftalign"> Grid files in <code>$PERM/%SUITE_NAME%/cluster/input/grids</code>  </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Conversion result (NetCDF format) and the GRIB file in <code>$TEMP/sms/input/%SUITE_NAME/</code><span style='color:red; '><code>$REQUEST_DATE</code></span>/  </td>
	</tr>
</table></div>
<!-- EDIT13 TABLE [5873-6419] --><ul>
<li class="level1"><div class="li"> The task <code>init_data</code> comprises the computation of cell_weights – but only if they have not been previously computed. This is indicated by the existence of a file</div>
</li>
</ul>
<pre class="code">        cluster/input/ifs2icon/cellweights/initialized.flag</pre>
<ul>
<li class="level1"><div class="li"> The task <code>init_data</code> loads the Climate data Operators <code>cdo</code> version 1.5.0. Note that the default version 1.4.6 installed on <code>c1a</code> cannot be used with <code>ifs2icon</code> while for the newer 1.5.3 NetCDF support has not been compiled in.</div>
</li>
<li class="level1"><div class="li"> The <code>ifs2icon</code> script contains a call to <code>cdo merge</code> which consumes a considerable amount of memory (for R2B06, the default of ~780MB is not sufficient). </div>
</li>
</ul>

</div>
<!-- EDIT12 SECTION "Task init/init_data" [5844-7060] -->
<h4 class="sectionedit14"><a name="task_init_build_init_svn" id="task_init_build_init_svn">Task init/build/init_svn</a></h4>
<div class="level4">
<div class="table sectionedit15"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Update ICON sources. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>ecgate</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Source code in directory <code>c1a:$PERM/%SUITE_NAME%/cluster/icon-dev</code>  </td>
	</tr>
</table></div>
<!-- EDIT15 TABLE [7095-7277] -->
<p>

There are two modes, depending on user-defined <code>%SVN_UPDATE%</code> flag:
</p>

<p>
<strong>Subversion update</strong>
</p>

<p>
Requires an existing source directory on compute cluster <code>c1a</code>. 
Apply only <code>svn update</code> and <code>gmake distclean</code> to retrieve the source code from the repository.
</p>

<p>
<strong>Tar-ball export</strong>
</p>

<p>
SVN export of a source copy in <code>$TMPDIR/icon-dev</code> (on <code>ecgate</code>), copy to the compute cluster <code>c1a</code>, where the files will be extracted (in task <code>init/build/init_build</code>).
</p>

</div>
<!-- EDIT14 SECTION "Task init/build/init_svn" [7061-7739] -->
<h4 class="sectionedit16"><a name="task_init_build_init_build" id="task_init_build_init_build">Task init/build/init_build</a></h4>
<div class="level4">
<div class="table sectionedit17"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Build ICON binary. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_parallel</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> Updated source directory, <code>c1a:$PERM/%SUITE_NAME%/cluster/icon-dev</code> </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Binary in <code>c1a:$PERM/%SUITE_NAME%/cluster/icon-dev/build/…/bin/</code>  </td>
	</tr>
</table></div>
<!-- EDIT17 TABLE [7776-8059] -->
</div>
<!-- EDIT16 SECTION "Task init/build/init_build" [7740-8063] -->
<h4 class="sectionedit18"><a name="task_forecast_prepare_pre_clean" id="task_forecast_prepare_pre_clean">Task forecast/prepare/pre_clean</a></h4>
<div class="level4">
<div class="table sectionedit19"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Clear directory with model run and output directory. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_serial</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Clears output directory <code>%TEMP%/sms/output/%SUITE_NAME%/</code><span style='color:red; '><code>$REQUEST_DATE</code></span>/  </td>
	</tr>
</table></div>
<!-- EDIT19 TABLE [8105-8351] -->
</div>
<!-- EDIT18 SECTION "Task forecast/prepare/pre_clean" [8064-8353] -->
<h4 class="sectionedit20"><a name="task_forecast_prepare_dumpstate" id="task_forecast_prepare_dumpstate">Task forecast/prepare/dumpstate</a></h4>
<div class="level4">
<div class="table sectionedit21"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Create dump state (containing coefficient tables for ICON run). </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_parallel</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> Case setup in <code>$PERM/%SUITE_NAME%/def</code>. </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> IFS data in <code>$TEMP/sms/input/</code>. </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> <code>control_model</code> binary in<code>$PERM/%SUITE_NAME%/cluster/icon-dev/build/…/bin/</code>. </td>
	</tr>
	<tr class="row5">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Dump state in <code>$TEMP/sms/output/%SUITE_NAME%/</code><span style='color:red; '><code>$REQUEST_DATE</code></span>/  </td>
	</tr>
</table></div>
<!-- EDIT21 TABLE [8395-8883] -->
</div>
<!-- EDIT20 SECTION "Task forecast/prepare/dumpstate" [8354-8887] -->
<h4 class="sectionedit22"><a name="task_forecast_model" id="task_forecast_model">Task forecast/model</a></h4>
<div class="level4">
<div class="table sectionedit23"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Model run. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_parallel</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> Case setup in <code>$PERM/%SUITE_NAME%/def</code>. </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> IFS data in <code>$TEMP/sms/input/</code>. </td>
	</tr>
	<tr class="row4">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> <code>control_model</code> binary in<code>$PERM/%SUITE_NAME%/cluster/icon-dev/build/…/bin/</code>. </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1 leftalign"> Dump state in <code>$TEMP/sms/output/%SUITE_NAME%/</code><span style='color:red; '><code>$REQUEST_DATE</code></span>/  </td>
	</tr>
	<tr class="row6">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Model output in <code>$TEMP/sms/output/%SUITE_NAME%/</code><span style='color:red; '><code>$REQUEST_DATE</code></span>/  </td>
	</tr>
	<tr class="row7">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> On abort or completion: Terminates <code>“check_progress”</code> by calling the utility script <code>cancel_check_progress</code>.  </td>
	</tr>
</table></div>
<!-- EDIT23 TABLE [8917-9609] -->
</div>
<!-- EDIT22 SECTION "Task forecast/model" [8888-9613] -->
<h4 class="sectionedit24"><a name="task_forecast_check_progress" id="task_forecast_check_progress">Task forecast/check_progress</a></h4>
<div class="level4">
<div class="table sectionedit25"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Check for available output files. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>ecgate</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> Terminates, if all NetCDF output files are available in <code>c1a:$TEMP/sms/output/%SUITE_NAME%/</code><span style='color:red; '><code>$REQUEST_DATE</code></span>/ or if on <code>ecgate</code> a file <code>$HOME/sms/model_complete.flag</code> has been created. </td>
	</tr>
	<tr class="row3">
		<td class="col0"> <strong>Provides output:</strong> </td><td class="col1 leftalign"> Increases SMS meter <code>“progress”</code>.  </td>
	</tr>
</table></div>
<!-- EDIT25 TABLE [9652-10052] -->
</div>
<!-- EDIT24 SECTION "Task forecast/check_progress" [9614-10052] -->
<h4 class="sectionedit26"><a name="task_post_post_process" id="task_post_post_process">Task post/post_process</a></h4>
<div class="level4">

<p>

This task is called for each output step separately.
</p>

<p>
<span style='color:red; '>Not yet implemented!</span>

</p>
<div class="table sectionedit27"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Extract output, generate plots. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>hpc_serial</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> Model output in <code>$TEMP/sms/output/%SUITE_NAME%/</code> </td>
	</tr>
</table></div>
<!-- EDIT27 TABLE [10180-10359] -->
</div>
<!-- EDIT26 SECTION "Task post/post_process" [10053-10361] -->
<h4 class="sectionedit28"><a name="task_post_post_archive" id="task_post_post_archive">Task post/post_archive</a></h4>
<div class="level4">

<p>

<span style='color:red; '>Not yet implemented!</span>

</p>
<div class="table sectionedit29"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> <strong>Objectives:</strong>      </td><td class="col1"> Copy output and/or store in database and/or trigger transfer to DWDExtract output, generate plots. </td>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign"> <strong>Platform:</strong>        </td><td class="col1"> <code>ecgate</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <strong>Requires input:</strong>  </td><td class="col1"> Model output in <code>$TEMP/sms/output/%SUITE_NAME%/</code> </td>
	</tr>
</table></div>
<!-- EDIT29 TABLE [10435-10677] -->
</div>
<!-- EDIT28 SECTION "Task post/post_archive" [10362-10681] -->
<h2 class="sectionedit30"><a name="technical_infrastructure" id="technical_infrastructure">Technical infrastructure</a></h2>
<div class="level2">

</div>
<!-- EDIT30 SECTION "Technical infrastructure" [10682-10720] -->
<h3 class="sectionedit31"><a name="setting_up_the_sms" id="setting_up_the_sms">Setting up the SMS</a></h3>
<div class="level3">

</div>
<!-- EDIT31 SECTION "Setting up the SMS" [10721-10750] -->
<h4 class="sectionedit32"><a name="sms_start" id="sms_start">sms_start</a></h4>
<div class="level4">

<p>

command
</p>
<pre class="code"> sms_start</pre>

<p>
gives

</p>
<pre class="code">User &quot;3455&quot; attempting to start sms server on &quot;ecgate&quot; using PROGNUM = &quot;903455&quot; and with SMSHOME of &quot;$HOME/sms_server&quot;

Checking if the SMS is already running on ecgate
...</pre>

<p>

Then write host and number to <code>.cdprc</code>:
</p>
<pre class="code"> alias myalias set SMS_PROG 903455 \; login ecgate UID 1</pre>

</div>
<!-- EDIT32 SECTION "sms_start" [10751-11086] -->
<h4 class="sectionedit33"><a name="running_the_suite" id="running_the_suite">Running the suite</a></h4>
<div class="level4">

<p>

In <code>ICON_r2B06_10d/def/smsfiles/</code> call
</p>
<pre class="code"> ./start_sms.sh</pre>

<p>
Run the suite with   
</p>
<pre class="code"> cdp
 
 CDP&gt; myalias    
 CDP&gt; play icon.def
 CDP&gt; begin icon   </pre>

<p>
Check the status of the suite with
</p>
<pre class="code"> cdp
 
 CDP&gt; myalias 
 CDP&gt; status -f
      /{sub}   icon{sub}   t1[sub]   </pre>

</div>
<!-- EDIT33 SECTION "Running the suite" [11087-11392] -->
<h4 class="sectionedit34"><a name="restarting_the_suite" id="restarting_the_suite">Restarting the suite</a></h4>
<div class="level4">

<p>

Add the following to your <code>$HOME/.cdprc</code> file:
</p>
<pre class="code">  define icon_restart {
     cancel -y icon
     play icon.def
     begin icon
  }</pre>

<p>
Then restart the ICON suite by typing 
</p>
<pre class="code"> cdp
 
 CDP&gt; myalias 
 CDP&gt; icon_restart
 
 cancel:/icon by UID@220
 unknown:/
 # MSG:play:Sending icon to ecgate
 # MSG:play:Suite icon defined.
 begin:/icon started by UID@220</pre>

</div>
<!-- EDIT34 SECTION "Restarting the suite" [11393-11802] -->
<h4 class="sectionedit35"><a name="logserver" id="logserver">Logserver</a></h4>
<div class="level4">

<p>

On the compute cluster <code>c1a</code> a special process is in charge of copying log files back to <code>ecgate</code> s.t. they can be viewed in <code>xcdp</code>:
</p>
<pre class="code">  cd $HOME/ICON_r2B06_10d/def/bin
  ./logserver</pre>

<p>
Now a log server daemon must be running:
</p>
<pre class="code">  ps -ef | grep $USER</pre>

<p>
yield something like
</p>
<pre class="code">  ...  418144       1   0 10:34:29 pts/172  0:00 /usr/bin/perl /usr/local/bin/logsvr.pl </pre>

</div>
<!-- EDIT35 SECTION "Logserver" [11803-12191] -->
<h3 class="sectionedit36"><a name="rhosts" id="rhosts">.rhosts</a></h3>
<div class="level3">

<p>

Enable <code>rcp</code> and <code>rsh</code> between the compute cluster and <code>ecgate</code> by setting the <code>$HOME/.rhosts</code> file:
</p>
<pre class="code">  echo &quot;ecga02 $USER&quot; &gt;&gt; ~/.rhosts</pre>

<p>
For copying files between ecgate and compute cluster we use the commands <code>rcp</code> or <code>ecrcp</code>.

</p>

</div>
<!-- EDIT36 SECTION ".rhosts" [12192-12451] -->
<h3 class="sectionedit37"><a name="svn_access" id="svn_access">SVN access</a></h3>
<div class="level3">

<p>

Automatic builds perform a complete <code>svn export</code>.
</p>

<p>
Please note: For direct access to ZMAW&#039;s subversion repository, changes in <code>$HOME/.subversion/servers</code>
are necessary:
</p>
<pre class="code">  http-proxy-host = ******
  http-proxy-port = ******</pre>

<p>
(Ask L. Kornblueh, F. Prill for details).
</p>

</div>
<!-- EDIT37 SECTION "SVN access" [12452-12747] -->
<h3 class="sectionedit38"><a name="local_ruby_installation" id="local_ruby_installation">Local Ruby installation</a></h3>
<div class="level3">

<p>

Script language <code>ruby</code> has to be installed locally (user account).
</p>

<p>
Prerequisites:
</p>
<ol>
<li class="level1"><div class="li"> Ruby source code downloaded from <a href="http://www.ruby-lang.org/de/downloads/" class="urlextern" title="http://www.ruby-lang.org/de/downloads/"  rel="nofollow">http://www.ruby-lang.org/de/downloads/</a> to <code>$PERM/software</code>.</div>
</li>
<li class="level1"><div class="li"> Package “extcsv” required; download from <a href="http://rubygems.org/gems/extcsv" class="urlextern" title="http://rubygems.org/gems/extcsv"  rel="nofollow">http://rubygems.org/gems/extcsv</a> to <code>$PERM/software/packages</code>.</div>
</li>
<li class="level1"><div class="li"> Package “gnuplot” required; download from <a href="http://rubygems.org/gems/gnuplot" class="urlextern" title="http://rubygems.org/gems/gnuplot"  rel="nofollow">http://rubygems.org/gems/gnuplot</a> to <code>$PERM/software/packages</code>.</div>
</li>
</ol>

<p>
Installation process:
</p>
<pre class="code">tar xvf ruby-1.9.3-p125.tar
cd ruby-1.9.3-p125
./configure --prefix=$PERM/software/ruby-1.9.3-p125_build
gmake -j6
gmake install
cd ../packages
$PERM/software/ruby-1.9.3-p125_build/bin/gem install extcsv
$PERM/software/ruby-1.9.3-p125_build/bin/gem install gnuplot</pre>

<p>
Patch required: In <code>$PERM/software/ruby-1.9.3-p125_build/lib/ruby/gems/1.9.1/gems/extcsv-0.12.0/lib/extcsv_diagram.rb</code> comment out require statement:
</p>
<pre class="code"> #require &#039;extcsv_units&#039;
 </pre>

</div>
<!-- EDIT38 SECTION "Local Ruby installation" [12748-13689] -->
<h3 class="sectionedit39"><a name="local_cdo_installation" id="local_cdo_installation">Local CDO installation</a></h3>
<div class="level3">

<p>

It is necessary to compile a local version of the <a href="https://code.zmaw.de/projects/cdo/files" class="urlextern" title="https://code.zmaw.de/projects/cdo/files"  rel="nofollow">Climate Data Operators</a>, which is <em class="u">newer</em> than v1.5.0,
because the system installation of the CDOs on <code>c1a</code> has not been compiled with NetCDF support.
The configure script must be provided with the correct system paths for NetCDF, Jasper and GRIB_<acronym title="Application Programming Interface">API</acronym>:

</p>
<pre class="code">ls -rlt
gunzip cdo-1.5.4.tar.gz
tar xvf cdo-1.5.4.tar
cd cdo-1.5.4
CC=xlc_r CFLAGS=&quot;-g -O3 -q64 -qhot -qarch=auto -qtune=auto -qsmp=omp -DHAVE_MMAP&quot; 
./configure -with-netcdf=/usr/local/apps/netcdf/3.6.3/LP64 \
 --prefix=$PERM/software/cdo-1.5.4_build \
 --with-grib_api=/usr/local/lib/metaps/lib/grib_api/1.9.9 \
 --with-jasper=/usr/local/apps/jasper/1.900.1/LP64 \
 --with-threads=yes
gmake -j2
gmake install</pre>

<p>

After successful compilation, all IFS2ICON processes must run with
</p>
<pre class="code"> $PERM/software/cdo-1.5.4_build/bin/cdo</pre>

<p>
To this end, the task <code>init_data.sms</code> exports an environment variable <code>CDOBIN</code> which is then used by the
Ruby script <code>ifs2icon.rb</code>.
</p>

</div>
<!-- EDIT39 SECTION "Local CDO installation" [13690-14746] -->
<h3 class="sectionedit40"><a name="grib_api_settings" id="grib_api_settings">GRIB_API settings</a></h3>
<div class="level3">

<p>

We want to use the same IFS2ICON configuration settings for ECMWF as well as for DWD, therefore the GRIB2 short names must be taken from DWD&#039;s definition files:
</p>
<pre class="code"> export GRIB_DEFINITION_PATH=%SCPERM%/software/usr/local/grib_api/release/share-1.9.9/definitions.edzw:/usr/local/lib/metaps/lib/grib_api/1.9.9/share/definitions</pre>

<p>
The directory ”%SCPERM%/software/usr/local/grib_api/release/share-1.9.9/definitions.edzw” can be tar&#039;ed and copied from DWD&#039;s HPC file system.
</p>

<p>
<em>Alternative approach:</em>
DWD GRIB definitions are already installed under
</p>
<pre class="code"> ~dwd/grib_api/definitions.edzw-${my_api_version}</pre>

<p>
One can set them using the script <code>/home/ms/de/dw7/bin/grib_def</code>.
</p>

</div>
<!-- EDIT40 SECTION "GRIB_API settings" [14747-15440] -->
<h3 class="sectionedit41"><a name="local_settings" id="local_settings">Local settings</a></h3>
<div class="level3">

<p>

MARS4ICON script must be executable:
</p>
<pre class="code">   chmod +x ~/ICON_r2B06_10d/icon-dev/scripts/preprocessing/mars4icon_smi_32r3+</pre>

<p>

Date conversion script <code>datconv</code> must be in <acronym title="Practical Extraction and Report Language">PERL</acronym>&#039;s search path:
</p>
<pre class="code">   cd $HOME/bin
   ln -s ~dfr/routfox/bin/datconv .
   ln -s ~dfr/routfox $HOME/
   export PERL5LIB=&quot;$HOME/routfox/perl&quot;</pre>

</div>
<!-- EDIT41 SECTION "Local settings" [15441-15782] -->
<h2 class="sectionedit42"><a name="still_todo" id="still_todo">Still TODO</a></h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Write platform independent scripts (using includes and conditionals).</div>
</li>
<li class="level1"><div class="li"> (With full access to IFS MARS data:) Enable retrieval for SMSDATE in task <code>get_data.sms</code></div>
</li>
<li class="level1"><div class="li"> increase no. of SMSTRIES for operational use</div>
</li>
<li class="level1"><div class="li"> <del>set wall clock time limits and node numbers</del></div>
</li>
<li class="level1"><div class="li"> check error code of the model binary</div>
</li>
<li class="level1"><div class="li"> runs build and dumpstate computation with a larger frequency.</div>
</li>
<li class="level1"><div class="li"> <del>Show a current computation date in XCDP</del></div>
</li>
<li class="level1"><div class="li"> Use multi-threaded version of CDOs</div>
</li>
<li class="level1"><div class="li"> Use <code>/home/ms/de/dw7/bin/grib_def</code> for GRIB definition.</div>
</li>
<li class="level1"><div class="li"> <del>perform IFS2ICON in a temporary directory (otherwise this might exceed the quota on <code>$PERM</code>).</del></div>
</li>
<li class="level1"><div class="li"> <del>Use SVN access on c1a for SVN update</del></div>
</li>
<li class="level1"><div class="li"> <del>Build with <code>-O3</code></del></div>
</li>
<li class="level1"><div class="li"> The input/output directories of older runs are not yet actively removed.</div>
</li>
</ul>

</div>
<!-- EDIT42 SECTION "Still TODO" [15783-] --></div>
</body>
</html>
