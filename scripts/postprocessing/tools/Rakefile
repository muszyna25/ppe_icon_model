require 'pp'

SRC                = ["icon_plot.ncl","icon_plot_lib.ncl"]
HOSTS              = ["m300064@blizzard.dkrz.de"]
DIR                = '/pool/data/ICON/tools'
DST                = HOSTS.map {|v| v + ':' + DIR}
CP                 = 'scp -p'
LS                 = 'ls -crtlh'
OCE_PLOT_TEST_FILE = ENV['HOME']+'/data/icon/oce.nc'
ATM_PLOT_TEST_FILE = ENV['HOME']+'/data/icon/atm.nc'
COMPARISON         = {:oce => OCE_PLOT_TEST_FILE, :atm => ATM_PLOT_TEST_FILE}
OFMT               = 'png'
DEFAULT_VARNAME    = 'T'
PLOT_CMD           = 'qiv'

# some helper methods for ease calling the icon plot scripts
def iconPlot(ifile,ofile,otype,varname,vartype='scalar',opts=[])
  libdir = FileUtils.pwd
  unless File.exists?(ifile)
    warn "Input file #{ifile} dows NOT exist!"
    exit
  end
  varIdent = (vartype == 'scalar') ? 'varName' : 'vecVars'

  cmd   ="ncl #{SRC[0]} 'altLibDir=\"#{libdir}\"' '#{varIdent}=\"#{varname}\"' 'iFile=\"#{ifile}\"' 'oFile=\"#{ofile}\"' 'oType=\"#{otype}\"' #{opts.join(' ')}"
  puts cmd
  sh cmd
end
def scalarPlot(ifile,ofile,otype,varname,opts=[])
  iconPlot(ifile,ofile,otype,varname,'scalar',opts)
end
def vectorPlot(ifile,ofile,otype,varname,opts=[])
  iconPlot(ifile,ofile,otype,varname,'vector',opts)
end

def del(file)
  FileUtils.rm(file) if File.exists?(file)
end
def show(*files)
  system("#{PLOT_CMD} #{files.join(' ')} &")
end
def defaultPlot(ifile,ofile,opts=[])
  scalarPlot(ifile,ofile,OFMT,DEFAULT_VARNAME,opts)
  ofile += ".#{OFMT}"
  show(ofile)
end

# Checking/installing the script files
desc "check files on pool"
task :default => [:check]

desc "check files on pool"
task :check do
  SRC.each {|src| HOSTS.each {|host| sh ['ssh',host,['"',LS,DIR,'"'].join(' ')].join(' ') }}
end

desc "install plotting tools in /pool on blizzard"
task :install do
  SRC.each {|src| DST.each {|dst| sh [CP,src,dst].join(' ') }}
end

# the basics
desc "perform simple oce plot from 3d var"
task :test_oce_3d do
  ofile          = 'test_icon_plot.' + OFMT
  del(ofile)
  varname        = 'T'
  scalarPlot(OCE_PLOT_TEST_FILE,ofile,OFMT,varname)
  show(ofile)
end
desc "perform simple oce plot from dd var"
task :test_oce_2d do
  ofile          = 'test_icon_plot.' + OFMT
  del(ofile)
  varname        = 'ELEV'
  scalarPlot(OCE_PLOT_TEST_FILE,ofile,OFMT,varname)
  show(ofile)
end
desc "perform simple atm plot from 3d var"
task :test_atm_3d do
  ofile          = 'test_icon_plot.' + OFMT
  del(ofile)
  varname        = 'T'
  scalarPlot(ATM_PLOT_TEST_FILE,ofile,OFMT,varname)
  show(ofile)
end
desc "perform simple atm plot from 2d var"
task :test_atm_2d do
  ofile          = 'test_icon_plot.' + OFMT
  del(ofile)
  varname        = 'SKT'
  scalarPlot(ATM_PLOT_TEST_FILE,ofile,OFMT,varname)
  show(ofile)
end

# selecting levels
desc "plot different levels of an ocean file"
task :test_plotlevels_oce do
  varname         = 'T'
  maxlev          = 10
  images, threads = [],[]
  (0...maxlev).each {|lev|
    ofile          = "test_icon_oce_plotlevel_#{lev}." + OFMT
    threads << Thread.new(ofile,varname,lev) {|ofile,varname,lev|
      del(ofile)
      scalarPlot(OCE_PLOT_TEST_FILE,ofile,OFMT,varname,["levIndex=#{lev}"])
    }
    images << ofile
  }
  threads.map(&:join)
  show(*images)
end
desc "plot different levels of an atmosphere file"
task :test_plotlevels_atm do
  varname         = 'T'
  maxlev          = 10
  images, threads = [],[]
  (0...maxlev).each {|lev|
    ofile          = "test_icon_atm_plotlevel_#{lev}." + OFMT
    threads << Thread.new(ofile,varname,lev) {|ofile,varname,lev|
      del(ofile)
      scalarPlot(ATM_PLOT_TEST_FILE,ofile,OFMT,varname,["levIndex=#{lev}","'atmLev=\"m\"'"])
    }
    images << ofile
  }
  threads.map(&:join)
  show(*images)
end

# vertical cross sections
desc "Try to plot vertical section of ocean model output"
task :test_section_oce do
  images = []
  secopts = ["'secLC=(/0,80/)'","'secRC=(/0,-80/)'","showSecMap=False","secPoints=100"]
  ofile = "test_section_ice"
  scalarPlot(OCE_PLOT_TEST_FILE,ofile,OFMT,DEFAULT_VARNAME,secopts)
  ofile += ".#{OFMT}"
  show(ofile)
end
desc "plot section of ocean and atmosphere (height, pressure and model level)"
task :test_sections do
  images = []
  secopts = ["'secLC=(/0,80/)'","'secRC=(/0,-80/)'","showSecMap=False","secPoints=100"]
  COMPARISON.each {|itype,ifile|
    ofile = "test_section_#{itype.to_s}"
    if itype == :atm
      scalarPlot(ifile,ofile+'h',OFMT,DEFAULT_VARNAME,secopts +["'atmLev=\"h\"'"]);images << ofile+'h'
      scalarPlot(ifile,ofile+'p',OFMT,DEFAULT_VARNAME,secopts +["'atmLev=\"p\"'"]);images << ofile+'p'
      scalarPlot(ifile,ofile+'m',OFMT,DEFAULT_VARNAME,secopts +["'atmLev=\"m\"'"]);images << ofile+'m'
    else
      scalarPlot(ifile,ofile,OFMT,DEFAULT_VARNAME,secopts); images << ofile
    end
  }
  images.map! {|i| i+= ".#{OFMT}"}
  show(*images)
end

desc "plot vectors of ocean input"
task :test_vector_oce do
  ofile='test_vector_oce'
  vectorPlot(OCE_PLOT_TEST_FILE,ofile,OFMT,'u-veloc v-veloc')
  show(ofile+'.png')
end
desc "plot vectors of atm input"
task :test_vector_atm do
  ofile='test_vector_atm'
  images = []

  ofile0 = ofile + '0'
  vectorPlot(ATM_PLOT_TEST_FILE,ofile0,OFMT,'U V',["vecRefLength=0.01"])
  images << ofile0+'.'+OFMT

  ofile1 = ofile + '1'
  vectorPlot(ATM_PLOT_TEST_FILE,ofile1,OFMT,'U V',["vecRefLength=0.01","'mapType=\"NHps\"'"])
  images << ofile1+'.'+OFMT

  show(images)
end

# orthographic projections
COMPARISON.each {|itype,ifile|
  itypeS = itype.to_s
  desc "orthographic plot (#{itypeS})"
  task "test_ortho_#{itypeS}".to_sym do
    defaultPlot(ifile,"ortho_#{itypeS}",["'mapType=\"ortho\"'"])
  end
}

# overlay plots
COMPARISON.each {|itype,ifile|
  vecvars = {:oce => 'u-veloc v-veloc',:atm => "U V"}[itype]
  itypeS = itype.to_s
  desc "overlay plot (#{itypeS})"
  task "test_overlay_#{itypeS}".to_sym do
    defaultPlot(ifile,"overlay_#{itypeS}",["'vecVars=\"#{vecvars}\"'",
                "'mapType=\"ortho\"'","'atmLev=\"m\"'","centerLon=120"])
  end
}

# uncategoriesed tests on
# * maptype
desc "test misc mpaTypes"
task :test_misc_maptypes do
  %w[SHps NHps sat lambert].each {|maptype|
    defaultPlot(ATM_PLOT_TEST_FILE,maptype,["'mapType=\"#{maptype}\"'","'atmLev=\"m\"'"])
  }
end
#==============================================================================
desc "all together now"
task :all_tests do
  tests = Rake::Task.tasks.find_all {|t| t.name =~ /^test/}
  pp tests.map(&:name)
  tests.each {|t|
    puts "################################################################################"
    puts "Running test #{t.name}:"
    t.execute
  }
end

# vim:ft=ruby
